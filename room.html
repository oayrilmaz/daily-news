<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTD Today — Intelligence Room</title>

  <style>
    :root{
      --paper:#e7dcc6;
      --ink:#1a1a1a;
      --muted:#6b6b6b;
      --panel:#ffffff33;
      --line:#00000022;
      --btn:#ffffff66;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Georgia, "Times New Roman", serif;
      color:var(--ink);
      background:var(--paper);
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    header{text-align:center;margin-bottom:18px}
    h1{margin:0;font-size:52px;letter-spacing:.5px}
    .tagline{margin-top:6px;color:var(--muted);font-style:italic}
    nav{display:flex;gap:22px;justify-content:center;margin-top:10px}
    nav a{color:var(--ink);text-decoration:none;border-bottom:1px solid transparent}
    nav a:hover{border-bottom-color:var(--ink)}
    .title{margin:22px 0 6px;text-align:center;font-size:28px}
    .updated{margin:0 0 18px;text-align:center;color:var(--muted);font-size:14px}

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:10px;
      padding:14px;
      backdrop-filter: blur(2px);
    }
    .hint{
      font-size:14px;
      color:#2b2b2b;
      background:#ffffff2e;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:10px;
      margin-bottom:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr .7fr .7fr;
      gap:10px;
      margin-bottom:10px;
    }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input,select,textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      background:#ffffff66;
      font-family: inherit;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--line);
      background:var(--btn);
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
      font-family: inherit;
      font-size:14px;
    }
    button:hover{background:#ffffff88}
    .btn-danger{
      border:1px solid #b24;
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    .btn-danger:hover{background:#fee}
    .btn-subtle{
      background:#ffffff3a;
    }

    .feedWrap{margin-top:14px}
    .feedHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 2px 8px;
      color:var(--muted);
      font-size:13px;
    }

    .feed{
      border:1px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      background:#ffffff2b;
    }
    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding:12px 14px;
      border-top:1px solid var(--line);
    }
    .item:first-child{border-top:none}
    .who{
      font-weight:700;
      margin-bottom:4px;
    }
    .meta{
      color:var(--muted);
      font-size:13px;
    }
    .msg{
      margin-top:8px;
      white-space:pre-wrap;
      line-height:1.25rem;
    }
    .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width:180px;
    }
    .pill{
      font-size:12px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#ffffff55;
      color:#333;
    }
    .when{
      font-size:12px;
      color:var(--muted);
    }
    .status{
      margin-left:auto;
      color:var(--muted);
      font-size:13px;
    }
    footer{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:18px;
    }

    @media (max-width:900px){
      .grid{grid-template-columns:1fr 1fr}
      .right{min-width:auto}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>PTD Today</h1>
      <div class="tagline">First to Know. First to Lead.</div>
      <nav>
        <a href="/index.html">Home</a>
        <a href="/ai.html">AI</a>
        <a href="/briefs.html">Briefs</a>
        <a href="/room.html"><b>Room</b></a>
      </nav>
    </header>

    <div class="title">PTD Intelligence Room</div>
    <div class="updated" id="updatedText">Updated —</div>

    <div class="panel">
      <div class="hint">
        <b>Allowed:</b> Grid • AI • Data Centers • Renewables • Oil &amp; Gas (infrastructure)<br/>
        <b>Not allowed:</b> Politics / elections / general geopolitics • hate • abuse • spam
      </div>

      <div class="grid">
        <div>
          <label for="name">Your name</label>
          <input id="name" type="text" value="Thomas Edison" />
        </div>
        <div>
          <label for="company">Company (optional)</label>
          <input id="company" type="text" placeholder="e.g., PTD Today / GE Vernova" />
        </div>
        <div>
          <label for="location">Location (optional)</label>
          <input id="location" type="text" placeholder="e.g., US / NC / EU / Dubai" />
        </div>
        <div>
          <label for="category">Category</label>
          <select id="category">
            <option value="job">Job</option>
            <option value="resource">Resource</option>
            <option value="equipment">Equipment</option>
            <option value="device">Device</option>
            <option value="labor">Labor</option>
            <option value="advice">Advice</option>
            <option value="recommendation">Recommendation</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div>
        <label for="message">Message</label>
        <textarea id="message" placeholder="Post your need or offer (professional + clean). Example: Need GIS commissioning support in Q2; looking for recommended contractors in the US."></textarea>
      </div>

      <div class="actions">
        <button id="postBtn">Post</button>
        <button class="btn-subtle" id="refreshBtn">Refresh feed</button>
        <button class="btn-subtle" id="clearAllBtn" style="display:none;">Admin: Clear all posts</button>
        <span class="status" id="status"></span>
      </div>

      <div class="feedWrap">
        <div class="feedHeader">
          <div><b>Room feed</b></div>
          <div id="feedMeta">—</div>
        </div>

        <div class="feed" id="feed">
          <div class="item">
            <div class="meta">No posts yet. Be the first to post a need or offer.</div>
            <div></div>
          </div>
        </div>
      </div>
    </div>

    <footer>© 2026 PTD Today — Intelligence Room.</footer>
  </div>

  <script>
    // === API base (not displayed on page) ===
    const API_BASE = "https://ptd-room-api.ozgurayrilmaz.workers.dev";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const feedEl = $("feed");
    const updatedTextEl = $("updatedText");
    const feedMetaEl = $("feedMeta");
    const clearAllBtn = $("clearAllBtn");

    const isAdmin = new URLSearchParams(location.search).get("admin") === "1";

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function getAdminToken() {
      if (!isAdmin) return null;
      let t = sessionStorage.getItem("PTD_ADMIN_TOKEN");
      if (!t) {
        t = prompt("Enter admin token to enable delete:");
        if (t) sessionStorage.setItem("PTD_ADMIN_TOKEN", t);
      }
      return t;
    }

    if (isAdmin) {
      clearAllBtn.style.display = "inline-block";
      // prompt early so buttons work immediately
      getAdminToken();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtWhen(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso || "";
      }
    }

    function renderFeed(items) {
      if (!Array.isArray(items) || items.length === 0) {
        feedEl.innerHTML = `
          <div class="item">
            <div class="meta">No posts yet. Be the first to post a need or offer.</div>
            <div></div>
          </div>
        `;
        return;
      }

      feedEl.innerHTML = items.map(item => {
        const who = escapeHtml(item.name || "");
        const company = item.company ? escapeHtml(item.company) : "";
        const loc = item.location ? escapeHtml(item.location) : "";
        const cat = escapeHtml(item.category || "");
        const msg = escapeHtml(item.message || "");
        const when = fmtWhen(item.created_at);

        const metaParts = [];
        if (company) metaParts.push(company);
        if (loc) metaParts.push(loc);

        const metaLine = metaParts.length ? (" • " + metaParts.join(" • ")) : "";

        const delBtn = isAdmin
          ? `<button class="btn-danger" data-del="${escapeHtml(item.id)}">Delete</button>`
          : "";

        return `
          <div class="item">
            <div>
              <div class="who">${who}${metaLine ? `<span class="meta"> ${metaLine}</span>` : ""}</div>
              <div class="msg">${msg}</div>
            </div>
            <div class="right">
              <div class="pill">${cat}</div>
              <div class="when">${escapeHtml(when)}</div>
              ${delBtn}
            </div>
          </div>
        `;
      }).join("");
    }

    async function refreshFeed() {
      setStatus("Loading…");
      try {
        const res = await fetch(`${API_BASE}/feed`, { method: "GET" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));

        renderFeed(data.feed);
        updatedTextEl.textContent = "Updated — " + new Date().toLocaleString();
        feedMetaEl.textContent = `Posts: ${data.count}`;
        setStatus("");
      } catch (e) {
        setStatus("Error: " + (e.message || e));
      }
    }

    async function postItem() {
      const payload = {
        name: $("name").value.trim(),
        company: $("company").value.trim() || null,
        location: $("location").value.trim() || null,
        category: $("category").value,
        message: $("message").value.trim(),
      };

      if (!payload.name) return setStatus("Please enter a name.");
      if (!payload.message) return setStatus("Please enter a message.");

      setStatus("Posting…");
      try {
        const res = await fetch(`${API_BASE}/post`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));

        $("message").value = "";
        setStatus("Posted ✓");
        await refreshFeed();
        setTimeout(() => setStatus(""), 1200);
      } catch (e) {
        setStatus("Error: " + (e.message || e));
      }
    }

    // Delete single item (admin)
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-del]");
      if (!btn) return;

      const id = btn.getAttribute("data-del");
      if (!id) return;

      if (!confirm("Delete this post?")) return;

      const token = getAdminToken();
      if (!token) return alert("Admin token missing.");

      try {
        const res = await fetch(`${API_BASE}/post/${encodeURIComponent(id)}`, {
          method: "DELETE",
          headers: { "x-admin-token": token },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));
        await refreshFeed();
      } catch (err) {
        alert("Delete failed: " + (err.message || err));
      }
    });

    // Clear all (admin)
    clearAllBtn.addEventListener("click", async () => {
      if (!isAdmin) return;
      if (!confirm("Clear ALL posts? This cannot be undone.")) return;

      const token = getAdminToken();
      if (!token) return alert("Admin token missing.");

      try {
        const res = await fetch(`${API_BASE}/feed`, {
          method: "DELETE",
          headers: { "x-admin-token": token },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));
        await refreshFeed();
      } catch (err) {
        alert("Clear failed: " + (err.message || err));
      }
    });

    $("postBtn").addEventListener("click", postItem);
    $("refreshBtn").addEventListener("click", refreshFeed);

    // Auto-load
    refreshFeed();
  </script>
</body>
</html>
<nav class="nav" aria-label="Primary navigation">
  <a href="/index.html">Home</a>
  <a href="/ai.html">AI</a>
  <a href="/briefs.html">Briefs</a>
  <a href="/room.html">Room</a>
</nav>