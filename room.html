<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTD Today — Intelligence Room</title>
  <style>
    :root{
      --bg:#efe6d6;
      --card:#f6f1e6;
      --ink:#111;
      --muted:#555;
      --line:rgba(0,0,0,.18);
      --btn:#e9dfcf;
      --btn2:#efe6d6;
      --shadow:0 8px 28px rgba(0,0,0,.10);
      --radius:16px;
    }
    body{
      margin:0;
      font-family: Georgia, "Times New Roman", Times, serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:980px;
      margin:34px auto 60px;
      padding:0 18px;
    }
    header{
      text-align:center;
      margin-bottom:18px;
    }
    .brand{
      font-size:48px;
      font-weight:700;
      letter-spacing:.5px;
      margin:0;
    }
    .tag{
      margin:6px 0 14px;
      font-style:italic;
      color:var(--muted);
    }
    nav{
      display:flex;
      justify-content:center;
      gap:30px;
      margin:10px 0 16px;
      font-size:15px;
    }
    nav a{
      color:var(--ink);
      text-decoration:none;
      border-bottom:1px solid transparent;
      padding-bottom:2px;
    }
    nav a:hover{ border-bottom-color:var(--ink); }
    h2{
      text-align:center;
      margin:0 0 6px;
      font-size:28px;
    }
    .updated{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin-bottom:18px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .rules{
      font-size:13px;
      color:#222;
      background:rgba(255,255,255,.35);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:12px;
      margin-bottom:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 180px;
      gap:10px;
      margin-bottom:10px;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:1fr; }
    }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-family:inherit;
      font-size:15px;
      background:rgba(255,255,255,.55);
      outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }

    .buttons{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 14px;
      font-family:inherit;
      font-size:15px;
      cursor:pointer;
      background:var(--btn);
    }
    button:hover{ background:var(--btn2); }

    .feedWrap{
      margin-top:14px;
      background:rgba(255,255,255,.22);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .feedTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .feedTitle{
      font-weight:700;
    }
    .feedMeta{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .post{
      border-top:1px solid var(--line);
      padding:10px 0;
    }
    .post:first-child{ border-top:none; padding-top:0; }
    .postHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .who{
      font-weight:700;
    }
    .pill{
      font-size:12px;
      border:1px solid var(--line);
      padding:2px 8px;
      border-radius:999px;
      color:#222;
      background:rgba(255,255,255,.35);
    }
    .where{
      color:var(--muted);
      font-size:13px;
    }
    .msg{
      margin-top:6px;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .status{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }
    footer{
      text-align:center;
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 class="brand">PTD Today</h1>
      <div class="tag">First to Know. First to Lead.</div>

      <nav>
        <a href="/index.html">Home</a>
        <a href="/ai.html">AI</a>
        <a href="/briefs.html">Briefs</a>
        <a href="/room.html"><b>Room</b></a>
      </nav>

      <h2>PTD Intelligence Room</h2>
      <div class="updated" id="updatedTop">Updated —</div>
    </header>

    <div class="card">
      <div class="rules">
        <b>Allowed:</b> Grid • AI • Data Centers • Renewables • Oil &amp; Gas (infrastructure)<br/>
        <b>Not allowed:</b> Politics / elections / general geopolitics • hate • abuse • spam
      </div>

      <!-- We intentionally do NOT ask for real name.
           Worker will assign a random real-style name if name is missing. -->

      <div class="grid">
        <input id="company" placeholder="Company (optional) — e.g., PTD Today / GE Vernova" />
        <input id="location" placeholder="Location (optional) — e.g., US / NC / EU / Dubai" />
        <select id="category">
          <option value="job">Job</option>
          <option value="resource">Resource</option>
          <option value="equipment">Equipment</option>
          <option value="device">Device</option>
          <option value="labor">Labor</option>
          <option value="advice">Advice</option>
          <option value="recommendation">Recommendation</option>
          <option value="other">Other</option>
        </select>
      </div>

      <textarea id="message" placeholder="Post your need or offer (professional + clean). Example: Need GIS commissioning support in Q2; looking for recommended contractors in the US."></textarea>

      <div class="buttons">
        <button id="btnPost">Post</button>
        <button id="btnRefresh" type="button">Refresh feed</button>
        <button type="button" onclick="window.location.href='/briefs.html'">Open Briefs</button>
      </div>

      <div class="status" id="status"></div>

      <div class="feedWrap">
        <div class="feedTop">
          <div class="feedTitle">Room feed</div>
          <div class="feedMeta" id="feedMeta">—</div>
        </div>
        <div id="feed"></div>
      </div>
    </div>

    <footer>© 2026 PTD Today — Intelligence Room</footer>
  </div>

  <script>
    // ✅ Update this to your Worker URL (do NOT display it on the page)
    const API_BASE = "https://ptd-room-api.ozgurayrilmaz.workers.dev";

    const el = (id) => document.getElementById(id);

    function setStatus(msg){
      el("status").textContent = msg || "";
    }

    function fmtTime(iso){
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return iso; }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderFeed(items){
      const wrap = el("feed");
      if (!items || !items.length){
        wrap.innerHTML = `<div class="where">No posts yet. Be the first to post a need or offer.</div>`;
        return;
      }

      wrap.innerHTML = items.map(it => {
        const who = escapeHtml(it.name || "—");
        const comp = it.company ? ` • ${escapeHtml(it.company)}` : "";
        const loc  = it.location ? ` • ${escapeHtml(it.location)}` : "";
        const cat  = escapeHtml(it.category || "other");
        const time = it.created_at ? fmtTime(it.created_at) : "";

        return `
          <div class="post">
            <div class="postHead">
              <div>
                <span class="who">${who}</span>
                <span class="where">${comp}${loc}</span>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <span class="pill">${cat}</span>
                <span class="where">${escapeHtml(time)}</span>
              </div>
            </div>
            <div class="msg">${escapeHtml(it.message || "")}</div>
          </div>
        `;
      }).join("");
    }

    async function refreshFeed(){
      setStatus("Loading feed…");
      try{
        const r = await fetch(`${API_BASE}/feed`, { method:"GET" });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || "Failed to load feed");
        renderFeed(data.feed || []);
        el("feedMeta").textContent = `Posts: ${data.count ?? (data.feed||[]).length} • ${new Date().toLocaleString()}`;
        el("updatedTop").textContent = `Updated — ${new Date().toLocaleString()}`;
        setStatus("");
      } catch(e){
        setStatus(`Feed error: ${e.message}`);
      }
    }

    async function postItem(){
      const payload = {
        // name intentionally omitted so Worker assigns a random “real” name
        company: el("company").value.trim(),
        location: el("location").value.trim(),
        category: el("category").value,
        message: el("message").value.trim()
      };

      if (!payload.message){
        setStatus("Please write a message first.");
        return;
      }

      setStatus("Posting…");
      try{
        const r = await fetch(`${API_BASE}/post`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json();

        if (!r.ok || !data.ok){
          throw new Error(data.error || `Post failed (${r.status})`);
        }

        el("message").value = "";
        setStatus("Posted. Refreshing feed…");
        await refreshFeed();
      } catch(e){
        setStatus(`Post error: ${e.message}`);
      }
    }

    el("btnPost").addEventListener("click", postItem);
    el("btnRefresh").addEventListener("click", refreshFeed);

    // Auto-load
    refreshFeed();
  </script>
</body>
</html>
