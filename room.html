<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics 4 -->
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVKD1RLFE5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-TVKD1RLFE5');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#E7DCC8" />
  <meta name="color-scheme" content="light only" />
  <meta name="description" content="PTD Intelligence Room: a focused space for Grid, AI, Data Centers, Renewables, Oil & Gas infrastructure." />
  <link rel="canonical" href="https://ptdtoday.com/room.html" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />

  <!-- Social -->
  <meta property="og:site_name" content="PTD Today" />
  <meta property="og:title" content="PTD Today — Intelligence Room" />
  <meta property="og:description" content="Weekly PTD Signals for Grid, AI, Data Centers, Renewables, and Energy infrastructure." />
  <meta property="og:image" content="/assets/og-default.png" />
  <meta property="og:url" content="https://ptdtoday.com/room.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <title>PTD Today — Intelligence Room</title>

  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/assets/main.css" />

  <style>
    header.site-header { text-align:center; margin:34px 10px 18px; }
    header.site-header h1 { margin:0 0 6px; font-size:56px; line-height:1; letter-spacing:.2px; }
    header.site-header h1 a { color:inherit; text-decoration:none; }
    header.site-header .motto { margin:2px 0 10px; color:#6F675D; font-style:italic; font-size:18px; }

    .ptd-nav { display:flex; justify-content:center; gap:22px; margin:6px 0 16px; font-size:14px; flex-wrap:wrap; }
    .ptd-nav a { text-decoration:none; color:#222; padding:6px 10px; border-radius:999px; }
    .ptd-nav a:hover { background:#f1ece3; }
    .ptd-nav a.active { font-weight:600; background:#e7dcc8; }

    .room-wrap{ max-width:980px; margin:0 auto; padding:0 14px 24px; }

    /* Single main card */
    .room-card{
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      background:rgba(255,255,255,.75);
      padding:14px;
      margin: 10px 0 16px;
      text-align:left;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:baseline;
      margin-bottom:10px;
    }

    .card-title{
      margin:0;
      font-size:16px;
      font-weight:800;
      color:#222;
      letter-spacing:.2px;
    }

    .card-meta{
      font-size:12px;
      color:#6F675D;
      white-space:nowrap;
    }

    .rules{
      border:1px solid rgba(0,0,0,.08);
      background: rgba(231,220,200,.35);
      border-radius:12px;
      padding:10px 10px 9px;
      font-size:13px;
      color:#222;
      margin: 10px 0 12px;
    }
    .rules b{ font-weight:700; }
    .rules .bad{ color:#9b1c1c; font-weight:600; }
    .rules .good{ color:#0a7a3b; font-weight:600; }

    /* Signals (10 lines max) */
    .signals{
      font-size:14px;
      line-height:1.55;
      color:#222;
      margin-top: 6px;
    }
    .signals ul{ margin: 6px 0 0 18px; padding: 0; }
    .signals li{ margin: 4px 0; }

    .muted{ color:#6F675D; }
    .divider{ height:1px; background:rgba(0,0,0,.08); margin: 14px 0; }

    .composer h3{
      margin:0 0 8px 0;
      font-size:14px;
      letter-spacing:.2px;
    }

    textarea{
      width:100%;
      min-height:92px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      font: inherit;
      resize: vertical;
      background:#fff;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color:#222;
      text-decoration:none;
      font-size:13px;
      cursor:pointer;
    }
    .btn:hover{ background:#f7f5f1; }
    .btn.secondary{
      background: rgba(231,220,200,.35);
      border-color: rgba(0,0,0,.10);
    }

    .note{ font-size:12px; color:#6F675D; line-height:1.4; }

    footer.footer{ margin-top: 18px; }
  </style>
</head>

<body>
  <div class="wrap" id="top">

    <header class="site-header">
      <h1 class="logo"><a href="/" aria-label="Go to PTD Today home">PTD Today</a></h1>
      <p class="motto">First to Know. First to Lead.</p>

      <nav class="ptd-nav" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ai.html">AI</a>
        <a href="/briefs.html">Briefs</a>
        <a href="/room.html" class="active">Room</a>
      </nav>

      <h2 class="section">PTD Intelligence Room</h2>
      <div class="updated" id="updated" role="status" aria-live="polite">Loading…</div>
    </header>

    <main class="main room-wrap" role="main">

      <section class="room-card" aria-label="Weekly PTD Signals">
        <div class="card-top">
          <p class="card-title">Weekly PTD Signals</p>
          <span class="card-meta" id="signalsUpdated">Loading…</span>
        </div>

        <div class="rules" role="note" aria-label="Room rules">
          <div><b>Allowed:</b> <span class="good">Grid • AI • Data Centers • Renewables • Oil &amp; Gas (infrastructure) • Critical minerals</span></div>
          <div><b>Not allowed:</b> <span class="bad">Politics / elections / general geopolitics</span></div>
        </div>

        <div class="signals" id="signalsBody">
          <p class="muted">Preparing…</p>
        </div>

        <div class="divider"></div>

        <div class="composer" aria-label="Draft box">
          <h3>Draft a message (UI-only)</h3>
          <textarea id="draft" placeholder="Write your post here… (UI only for now)"></textarea>

          <div class="row">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn secondary" id="insertSignals">Insert signals (10)</button>
              <button class="btn secondary" id="copyDraft">Copy draft</button>
              <button class="btn" id="clearDraft">Clear</button>
              <a class="btn" href="/briefs.html" target="_blank" rel="noopener">Open Briefs</a>
            </div>
            <span class="note">Posting inside PTD Room is disabled in v1 (no backend yet).</span>
          </div>
        </div>
      </section>

    </main>

    <footer class="footer">
      <p>© <span id="yr"></span> PTD Today — Intelligence Room.</p>
      <p class="muted">This page is a UI-only prototype. Interactive posting will be added in a later version.</p>
    </footer>

  </div>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();
    document.getElementById('updated').textContent =
      "Updated — " + new Date().toISOString().replace('T',' ').replace(/:\d\d\.\d{3}Z$/,'Z');

    // --- Simple filter to reduce political leakage (client-side safety net) ---
    // (Not perfect; the real fix is at the data pipeline, but this helps immediately.)
    const BLOCK_WORDS = [
      "election","mayor","senate","congress","parliament","president","prime minister",
      "trump","biden","erdogan","putin","zelensky",
      "campaign","vote","voting","party","democrat","republican",
      "swears in","inauguration"
    ];

    function isBlocked(text){
      const t = String(text || "").toLowerCase();
      return BLOCK_WORDS.some(w => t.includes(w));
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Extract up to 10 signal lines from summary_md (bullets or numbered)
    function extractSignals(md, max=10){
      const raw = (md || "").replace(/\r\n/g,"\n");
      const lines = raw.split("\n").map(x => x.trim()).filter(Boolean);

      const bullets = [];
      for(const line of lines){
        const isBullet = line.startsWith("- ") || line.startsWith("• ");
        if(isBullet){
          const item = line.replace(/^(- |• )/,"").trim();
          if(item) bullets.push(item);
        }
      }

      // fallback: take non-heading short lines
      if(bullets.length === 0){
        for(const line of lines){
          if(line.startsWith("#")) continue;
          if(line.length < 140) bullets.push(line);
        }
      }

      // Filter politics & return max lines
      const filtered = bullets.filter(x => !isBlocked(x));
      return filtered.slice(0, max);
    }

    let latestSignals = [];

    (async function(){
      const upd = document.getElementById("signalsUpdated");
      const body = document.getElementById("signalsBody");

      try{
        const res = await fetch("/data/briefs/weekly.json", { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        upd.textContent = "Updated: " + (data.updated_at || new Date().toISOString());

        latestSignals = extractSignals((data.summary_md || "").trim(), 10);

        if(latestSignals.length === 0){
          body.innerHTML = "<p class='muted'>No eligible PTD signals found this week (or they were filtered out). Check the brief source.</p>";
          return;
        }

        body.innerHTML = "<ul>" + latestSignals.map(x => "<li>" + escapeHtml(x) + "</li>").join("") + "</ul>";
      }catch(e){
        upd.textContent = "Not available yet";
        body.innerHTML = "<p class='muted'>Once <code>/data/briefs/weekly.json</code> is published, weekly signals will appear here.</p>";
      }
    })();

    const draft = document.getElementById("draft");

    document.getElementById("insertSignals")?.addEventListener("click", () => {
      const block = latestSignals.length
        ? ("Weekly PTD Signals:\n" + latestSignals.map(s => "• " + s).join("\n"))
        : "Weekly PTD Signals:\n• (No signals available yet)";
      draft.value = (draft.value ? draft.value + "\n\n" : "") + block;
      draft.focus();
    });

    document.getElementById("copyDraft")?.addEventListener("click", async () => {
      try{ await navigator.clipboard.writeText(draft.value || ""); }catch(e){}
    });

    document.getElementById("clearDraft")?.addEventListener("click", () => {
      draft.value = "";
      draft.focus();
    });
  </script>
</body>
</html>