<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics 4 -->
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVKD1RLFE5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-TVKD1RLFE5');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#E7DCC8" />
  <meta name="color-scheme" content="light only" />
  <meta name="description" content="PTD Intelligence Room: a focused community space for Grid, AI, Data Centers, Renewables, and Energy infrastructure." />
  <link rel="canonical" href="https://ptdtoday.com/room.html" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />

  <!-- Social -->
  <meta property="og:site_name" content="PTD Today" />
  <meta property="og:title" content="PTD Today — Intelligence Room" />
  <meta property="og:description" content="A focused space for Grid, AI, Data Centers, Renewables, and Energy infrastructure." />
  <meta property="og:image" content="/assets/og-default.png" />
  <meta property="og:url" content="https://ptdtoday.com/room.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <title>PTD Today — Intelligence Room</title>

  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/assets/main.css" />

  <style>
    header.site-header { text-align:center; margin: 34px 10px 18px; }
    header.site-header h1 { margin:0 0 6px; font-size:56px; line-height:1; letter-spacing:.2px; }
    header.site-header h1 a { color:inherit; text-decoration:none; }
    header.site-header .motto { margin:2px 0 10px; color:#6F675D; font-style:italic; font-size:18px; }

    .ptd-nav { display:flex; justify-content:center; gap:22px; margin:6px 0 16px; font-size:14px; flex-wrap:wrap; }
    .ptd-nav a { text-decoration:none; color:#222; padding:6px 10px; border-radius:999px; }
    .ptd-nav a:hover { background:#f1ece3; }
    .ptd-nav a.active { font-weight:600; background:#e7dcc8; }

    .room-wrap{ max-width: 980px; margin: 0 auto; padding: 0 14px 24px; }

    .panel{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      background: #fff;
      padding: 14px;
      margin-bottom: 14px;
    }

    .rules{
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(231,220,200,.35);
      border-radius: 12px;
      padding: 10px 10px 9px;
      font-size: 13px;
      color:#222;
      margin-bottom: 12px;
    }
    .rules b{ font-weight:700; }
    .rules .bad{ color:#9b1c1c; font-weight:600; }
    .rules .good{ color:#0a7a3b; font-weight:600; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 160px; }

    label{ font-size:12px; color:#6F675D; display:block; margin: 2px 0 6px; }
    input, select, textarea{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      font: inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background:#fff;
      color:#222;
      text-decoration:none;
      font-size: 13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{ background:#f7f5f1; }
    .btn.primary{
      background: rgba(231,220,200,.55);
      border-color: rgba(0,0,0,.10);
      font-weight: 600;
    }

    .meta { font-size: 12px; color:#6F675D; }
    .status { font-size: 12px; color:#6F675D; margin-top: 8px; }
    .status.ok { color:#0a7a3b; }
    .status.err { color:#9b1c1c; }

    .feed{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      background: #fff;
      padding: 12px;
    }
    .item-top{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      align-items:baseline;
      margin-bottom: 6px;
    }
    .who{ font-weight: 700; font-size: 13px; }
    .tag{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fafafa;
    }
    .when{ font-size:12px; color:#6F675D; }
    .msg{ white-space: pre-wrap; line-height: 1.5; font-size: 13px; margin-top: 6px; }
    .sub{ font-size: 12px; color:#6F675D; margin-top: 6px; }

    .divider{ height:1px; background: rgba(0,0,0,.08); margin: 12px 0; }

    .footer { text-align:center; padding: 22px 10px 28px; color:#6F675D; font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap" id="top">

    <header class="site-header">
      <h1 class="logo"><a href="/" aria-label="Go to PTD Today home">PTD Today</a></h1>
      <p class="motto">First to Know. First to Lead.</p>

      <nav class="ptd-nav" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ai.html">AI</a>
        <a href="/briefs.html">Briefs</a>
        <a href="/room.html" class="active">Room</a>
      </nav>

      <h2 class="section">PTD Intelligence Room</h2>
      <div class="updated" id="updated" role="status" aria-live="polite">Loading…</div>
    </header>

    <main class="main room-wrap" role="main">

      <!-- CHAT/POST BOX (TOP) -->
      <section class="panel" aria-label="Post to the room">
        <div class="rules" role="note" aria-label="Room rules">
          <div><b>Allowed:</b> <span class="good">Grid • AI • Data Centers • Renewables • Oil &amp; Gas (infrastructure)</span></div>
          <div><b>Not allowed:</b> <span class="bad">Politics / elections / general geopolitics • hate • abuse • spam</span></div>
        </div>

        <div class="row">
          <div>
            <label for="name">Your name (real name)</label>
            <input id="name" placeholder="e.g., Ozgur Ayrilmaz" autocomplete="name" />
          </div>

          <div>
            <label for="company">Company (optional)</label>
            <input id="company" placeholder="e.g., PTD Today / GE Vernova / EPC / OEM" />
          </div>

          <div>
            <label for="location">Location (optional)</label>
            <input id="location" placeholder="e.g., US / NC / EU / Dubai" />
          </div>

          <div>
            <label for="category">Category</label>
            <select id="category">
              <option value="job">Job</option>
              <option value="resource">Resource</option>
              <option value="equipment">Equipment</option>
              <option value="device">Device</option>
              <option value="labor">Labor</option>
              <option value="advice">Advice</option>
              <option value="recommendation">Recommendation</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="message">Message</label>
          <textarea id="message" placeholder="Post your need or offer (professional + clean). Example: Need GIS commissioning support in Q2; looking for recommended contractors in the US."></textarea>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="sendBtn">Post</button>
          <button class="btn" id="refreshBtn">Refresh feed</button>
          <a class="btn" href="/briefs.html" target="_blank" rel="noopener">Open Briefs</a>
          <span class="meta" id="apiMeta">API: loading…</span>
        </div>

        <div class="status" id="status"></div>
      </section>

      <!-- FEED (BELOW) -->
      <section class="panel" aria-label="Room feed">
        <div class="row" style="justify-content:space-between;">
          <h3 style="margin:0; font-size:14px; letter-spacing:.2px;">Room feed</h3>
          <span class="meta" id="feedMeta">Loading…</span>
        </div>
        <div class="divider"></div>
        <div class="feed" id="feed"></div>
      </section>

    </main>

    <footer class="footer">
      <p>© <span id="yr"></span> PTD Today — Intelligence Room.</p>
      <p class="muted">Backend is live via Cloudflare Workers. Persistence will be added next (KV/D1) so posts survive restarts.</p>
    </footer>

  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://ptd-room-api.ozgurayrilmaz.workers.dev";

    // ====== UI helpers ======
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const feedEl = $("feed");
    const feedMeta = $("feedMeta");
    const apiMeta = $("apiMeta");

    function setStatus(msg, type){
      statusEl.textContent = msg || "";
      statusEl.className = "status " + (type || "");
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function fmtTime(iso){
      if(!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleString();
      }catch(e){ return iso; }
    }

    function renderFeed(items){
      feedEl.innerHTML = "";
      if(!Array.isArray(items) || items.length === 0){
        feedEl.innerHTML = `<div class="meta">No posts yet. Be the first to post a need or offer.</div>`;
        return;
      }

      for(const it of items){
        const who = escapeHtml(it.name || "Anonymous");
        const cat = escapeHtml(it.category || "other");
        const when = escapeHtml(fmtTime(it.created_at));
        const msg = escapeHtml(it.message || "");
        const subParts = [];
        if(it.company) subParts.push(escapeHtml(it.company));
        if(it.location) subParts.push(escapeHtml(it.location));

        const sub = subParts.length ? subParts.join(" • ") : "";

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-top">
            <div class="who">${who}</div>
            <div class="tag">${cat}</div>
            <div class="when">${when}</div>
          </div>
          <div class="msg">${msg}</div>
          ${sub ? `<div class="sub">${sub}</div>` : ``}
        `;
        feedEl.appendChild(div);
      }
    }

    // ====== API calls ======
    async function loadFeed(){
      try{
        feedMeta.textContent = "Loading…";
        const res = await fetch(`${API_BASE}/feed`, { cache: "no-store" });
        const data = await res.json();
        renderFeed(data);
        feedMeta.textContent = `Updated: ${new Date().toLocaleString()} • ${Array.isArray(data) ? data.length : 0} posts`;
        setStatus("", "");
      }catch(e){
        feedMeta.textContent = "Feed not available";
        setStatus("Could not load feed. Check the Worker is deployed and reachable.", "err");
      }
    }

    async function postMessage(){
      const name = $("name").value.trim();
      const company = $("company").value.trim();
      const location = $("location").value.trim();
      const category = $("category").value;
      const message = $("message").value.trim();

      if(!name){
        setStatus("Please enter your real name (required).", "err");
        $("name").focus();
        return;
      }
      if(message.length < 10){
        setStatus("Message is too short. Please add a bit more detail (10+ characters).", "err");
        $("message").focus();
        return;
      }

      setStatus("Posting…", "");
      try{
        const res = await fetch(`${API_BASE}/post`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name, category, message,
            company: company || undefined,
            location: location || undefined
          })
        });

        const data = await res.json().catch(() => ({}));

        if(!res.ok){
          setStatus(data?.error ? `Rejected: ${data.error}` : `Rejected: HTTP ${res.status}`, "err");
          return;
        }

        setStatus("Posted successfully ✅", "ok");
        $("message").value = "";
        await loadFeed();
      }catch(e){
        setStatus("Post failed. Check CORS/API and try again.", "err");
      }
    }

    // ====== boot ======
    document.getElementById('yr').textContent = new Date().getFullYear();
    const updatedEl = document.getElementById('updated');
    if(updatedEl) updatedEl.textContent = "Updated — " + new Date().toISOString().replace('T',' ').replace(/:\d\d\.\d{3}Z$/,'Z');

    apiMeta.textContent = `API: ${API_BASE}`;

    $("sendBtn").addEventListener("click", postMessage);
    $("refreshBtn").addEventListener("click", loadFeed);

    // auto refresh
    loadFeed();
    setInterval(loadFeed, 10000);
  </script>
</body>
</html>
