<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PTD Today — Daily Energy & Power News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Curated daily & weekly news for grid, substations, protection & control, cables, HVDC, renewables, policy and more." />
  <link rel="icon" href="logo.svg" />
  <style>
    :root{ --ink:#111; --ink2:#555; --line:#e6e6e6 }
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--ink);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    header{border-bottom:1px solid var(--line);padding:28px 0 18px}
    h1{margin:0;font:700 48px/1.1 Georgia,'Times New Roman',Times,serif;text-align:center}
    .motto{margin-top:6px;text-align:center;color:var(--ink2);font-weight:500}
    .kicker{margin:16px 0 10px;text-align:center;
      font:600 22px/1.25 Georgia,'Times New Roman',Times,serif}
    nav{display:flex;gap:18px;justify-content:center;flex-wrap:wrap;
      border-bottom:1px solid var(--line);padding:10px 0 12px;margin-bottom:6px}
    nav a{color:inherit;text-decoration:none;font-weight:600}
    nav a.active{text-decoration:underline;text-underline-offset:6px}
    .updated{display:inline-block;border:1px solid var(--line);border-radius:22px;
      padding:6px 12px;margin:10px 0 0;color:var(--ink2);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:22px;margin:18px 0 60px}
    .card{display:grid;grid-template-columns:130px 1fr;gap:16px;border-top:1px solid var(--line);padding-top:16px}
    .thumb{width:130px;height:90px;object-fit:cover;border:1px solid var(--line);background:#f6f6f6}
    .title{font:700 24px/1.2 Georgia,'Times New Roman',Times,serif;margin:0 0 6px}
    .meta{color:var(--ink2);font-size:14px;margin-bottom:6px}
    .dek{color:var(--ink);margin:6px 0 10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer;font-size:14px}
    .btn:hover{border-color:#ccc}
    footer{border-top:1px solid var(--line);padding:18px 0 40px;color:var(--ink2);text-align:center}
    /* Share modal */
    .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.18);z-index:50}
    .modal{width:min(92vw,460px);background:#fff;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.18);overflow:hidden}
    .modal header{padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal h4{margin:0;font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .share-list{display:flex;flex-direction:column}
    .share-item{padding:14px 18px;border-top:1px solid var(--line);text-align:left;background:#fff;cursor:pointer;font-size:16px}
    .share-item:active{background:#f7f7f7}
    .close-row{padding:12px 16px;border-top:1px solid var(--line);text-align:right}
    .link-like{color:#555;text-decoration:underline;cursor:pointer}
    /* Toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;
      padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;pointer-events:none;transition:.25s ease;z-index:60}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
    @media (max-width:720px){
      h1{font-size:40px}
      .card{grid-template-columns:110px 1fr}
      .thumb{width:110px;height:78px}
      .title{font-size:20px}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>PTD Today</h1>
    <div class="motto">First to Know. First to Lead.</div>
    <div class="kicker">Daily Energy &amp; Power News</div>
    <nav id="tabs">
      <a href="#" data-filter="all" class="active">All</a>
      <a href="#" data-filter="top7">Top (7d)</a>
      <a href="#" data-filter="grid">Grid</a>
      <a href="#" data-filter="substations">Substations</a>
      <a href="#" data-filter="protection">Protection</a>
      <a href="#" data-filter="cables">Cables</a>
      <a href="#" data-filter="hvdc">HVDC</a>
      <a href="#" data-filter="renewables">Renewables</a>
      <a href="#" data-filter="policy">Policy</a>
    </nav>
    <div class="updated" id="updated">Updated —</div>
  </header>

  <main class="wrap">
    <section class="grid" id="list" aria-live="polite"></section>
  </main>

  <footer class="wrap">© 2025 PTD Today • Headlines link to their original publishers.</footer>

  <!-- Share modal -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-label="Share options">
    <div class="modal">
      <header><h4>Share</h4></header>
      <div class="share-list">
        <button class="share-item" data-type="linkedin">LinkedIn</button>
        <button class="share-item" data-type="x">X (Twitter)</button>
        <button class="share-item" data-type="facebook">Facebook</button>
        <button class="share-item" data-type="reddit">Reddit</button>
        <button class="share-item" data-type="copy">Copy link</button>
        <button class="share-item" data-type="email">Email</button>
      </div>
      <div class="close-row"><span class="link-like" id="closeShare">Close ×</span></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Link copied</div>

  <script>
  (function(){
    const listEl = document.getElementById('list');
    const updatedEl = document.getElementById('updated');

    // --- Robust copy helper (works on iOS Safari) ---
    async function copyText(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          showToast('Link copied');
          return;
        }
      }catch(_) {}
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly','');
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Link copied');
      }catch(_){
        prompt('Copy link:', text); // ultimate fallback
      }
    }
    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1400);
    }

    // Build a ptd link (shortlink if available; else article.html)
    function buildPtdLink(item){
      if(item.s){ return `/s/${item.s}.html`; }
      const u = new URL('/article.html', location.origin);
      u.searchParams.set('u', item.url);
      if(item.title)  u.searchParams.set('t', item.title);
      if(item.image)  u.searchParams.set('i', item.image);
      if(item.summary)u.searchParams.set('d', item.summary);
      return u.toString();
    }

    // Render one card
    function renderItem(item){
      const ptdUrl = buildPtdLink(item);
      const el = document.createElement('article');
      el.className = 'card';
      el.innerHTML = `
        <img class="thumb" src="${item.image ? item.image : '/assets/og-default.png'}" alt="">
        <div>
          <h3 class="title"><a href="${ptdUrl}">${item.title || 'Untitled'}</a></h3>
          <div class="meta">${(new URL(item.url)).hostname.replace(/^www\./,'')}</div>
          ${item.summary ? `<div class="dek">${item.summary}</div>` : ``}
          <div class="actions">
            <a class="btn" href="${ptdUrl}">Open on PTD Today</a>
            <button class="btn btn-share" data-ptd="${ptdUrl}">Share</button>
            <a class="btn" href="${item.url}" target="_blank" rel="noopener">Source</a>
          </div>
        </div>
      `;
      // local share button
      el.querySelector('.btn-share').addEventListener('click', (e)=>{
        openShare(e.currentTarget.getAttribute('data-ptd'));
      });
      return el;
    }

    // Load data
    async function load(){
      const data = await fetch('/data/news.json?v='+Date.now()).then(r=>r.json());
      updatedEl.textContent = 'Updated — ' + (data.updated || '');
      const items = data.items || [];
      listEl.innerHTML = '';
      items.forEach(item => listEl.appendChild(renderItem(item)));
      wireTabs(items);
    }

    // Simple category filter (client-side)
    function wireTabs(items){
      const tabs = document.querySelectorAll('#tabs a');
      tabs.forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          tabs.forEach(x=>x.classList.remove('active'));
          a.classList.add('active');
          const f = a.getAttribute('data-filter');
          listEl.innerHTML = '';
          let subset = items;
          if(f && f!=='all' && f!=='top7'){
            subset = items.filter(x => (x.cats||[]).includes(f));
          }else if(f==='top7'){
            subset = items.filter(x => (x.score||0) >= (dataTopCutoff || 0));
          }
          subset.forEach(item => listEl.appendChild(renderItem(item)));
        });
      });
    }

    // --- Share modal (always share PTD link) ---
    const backdrop = document.getElementById('shareBackdrop');
    const closeShare = document.getElementById('closeShare');
    let currentShareLink = '';

    function openShare(ptdLink){
      currentShareLink = ptdLink;
      backdrop.style.display='flex';
    }
    function closeModal(){ backdrop.style.display='none'; }
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });
    closeShare.addEventListener('click', closeModal);
    backdrop.querySelectorAll('.share-item').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        doShare(btn.getAttribute('data-type'));
      });
    });

    function doShare(kind){
      const link = currentShareLink || location.href;
      const title = document.title.replace(/^PTD Today —\s*/,'') || 'PTD Today';
      let url = '';
      if(kind==='linkedin'){
        url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(link)}`;
      }else if(kind==='x'){
        url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(link)}&text=${encodeURIComponent(title)}`;
      }else if(kind==='facebook'){
        url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
      }else if(kind==='reddit'){
        url = `https://www.reddit.com/submit?url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}`;
      }else if(kind==='email'){
        const subj = `PTD Today: ${title}`;
        const body = `${title}\n\n${link}`;
        url = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
      }else if(kind==='copy'){
        copyText(link);
        closeModal();
        return;
      }
      if(url) window.open(url,'_blank','noopener');
      closeModal();
    }

    // Optional: threshold for “Top (7d)” if your JSON exports one
    const dataTopCutoff = 0; // set by workflow if desired

    load();
  })();
  </script>
</body>
</html>