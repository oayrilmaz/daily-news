<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTD Today | Power Transmission & Distribution Daily News</title>

  <!-- Homepage OG so LinkedIn shows a card for ptdtoday.com -->
  <meta name="description" content="Daily headlines across power transmission & distribution, HV substations, protection & control, cables, grid modernization, policy, and more.">
  <meta property="og:title" content="PTD Today — Daily Energy & Power News">
  <meta property="og:description" content="Curated headlines across Power T&D, refreshed throughout the day.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ptdtoday.com/">
  <meta property="og:image" content="https://ptdtoday.com/logo.svg">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{
      --ink:#0b0b0b; --ink2:#333; --ink3:#666; --line:#e6e6e6; --bg:#fff;
      --maxw:1000px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);}
    body{font-family:Georgia, 'Times New Roman', Times, serif; line-height:1.5}

    /* Masthead */
    header{background:#fff;border-bottom:1px solid var(--line)}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:0 18px}
    .mast{padding:28px 0 8px}
    .brandRow{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    .brand{font-size:48px;font-weight:800;letter-spacing:.2px;line-height:1.05}
    .motto{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink3);font-size:14px}
    .strap{font-size:22px;font-weight:700;margin-top:6px}
    .subhed{font-size:15px;color:var(--ink3);margin-top:6px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .hr{height:1px;background:var(--line);margin:14px 0}

    /* Top nav / filters */
    nav{padding:10px 0}
    .tabs{display:flex;gap:20px;flex-wrap:wrap;align-items:center}
    .tab{font-size:16px;text-decoration:none;color:var(--ink2)}
    .tab[aria-current="true"]{color:var(--ink);font-weight:700}
    .stamp{margin-left:auto;font-size:12px;color:var(--ink3);border:1px solid var(--line);border-radius:18px;padding:4px 10px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    /* One-column feed */
    main{padding:16px 0 40px}
    .lead{border-bottom:1px solid var(--line);padding-bottom:16px;margin-bottom:16px}
    .lead h1{font-size:34px;line-height:1.12;margin:4px 0 8px}
    .lead .dek{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink2);font-size:15px;margin:6px 0 10px}
    .lead img{width:100%;max-height:180px;object-fit:cover;border:1px solid var(--line)}
    .meta{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:12px;color:var(--ink3);margin:8px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;border:1px solid var(--line);background:#fafafa;padding:7px 12px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--ink);text-decoration:none}
    .btn:hover{background:#f2f2f2}

    .feed{display:grid;gap:22px}
    .card{border-top:1px solid var(--line);padding-top:14px}
    .card h3{font-size:24px;line-height:1.16;margin:0 0 6px}
    .card .dek{font-family:ui-sans-serif;color:var(--ink2);font-size:14px;margin:6px 0 8px}
    .thumb{width:100%;max-height:180px;object-fit:cover;border:1px solid var(--line);margin:8px 0 6px;display:none}

    footer{border-top:1px solid var(--line);padding:16px 0 36px;color:var(--ink3);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:12px}

    /* Floating refresh bottom-right */
    .floating{position:fixed;right:16px;bottom:16px;z-index:30}
  </style>
</head>
<body>
<header>
  <div class="wrap mast">
    <div class="brandRow">
      <div class="brand">PTD Today</div>
      <div class="motto">First to Know. First to Lead.</div>
    </div>
    <div class="strap">Daily Energy &amp; Power News</div>
    <div class="subhed">Curated coverage for grid, HV substations, protection &amp; control, cables, policy, and more.</div>
  </div>
  <div class="hr"></div>
  <nav class="wrap">
    <div class="tabs" id="tabs">
      <a href="#" class="tab" data-filter="all" aria-current="true">All</a>
      <a href="#" class="tab" data-filter="grid">Grid</a>
      <a href="#" class="tab" data-filter="substation">Substations</a>
      <a href="#" class="tab" data-filter="protection">Protection</a>
      <a href="#" class="tab" data-filter="cable">Cables</a>
      <a href="#" class="tab" data-filter="hvdc">HVDC</a>
      <a href="#" class="tab" data-filter="renewable">Renewables</a>
      <a href="#" class="tab" data-filter="policy">Policy</a>
      <span class="stamp" id="updated">Updated —</span>
    </div>
  </nav>
</header>

<main class="wrap">
  <!-- Lead -->
  <article class="lead" id="lead">
    <h1 id="leadTitle">Loading…</h1>
    <div class="dek" id="leadDek"></div>
    <img id="leadImg" alt="Lead image">
    <div class="meta" id="leadMeta"></div>
    <div class="row">
      <a id="leadOpen" class="btn" href="#">Open on PTD Today</a>
      <button id="leadShare" class="btn" type="button">Share</button>
      <a id="leadSource" class="btn" target="_blank" rel="noopener">Source</a>
    </div>
  </article>

  <!-- Stacked feed -->
  <section class="feed" id="feed"></section>
</main>

<footer>
  <div class="wrap">© 2025 PTD Today. Headlines link to their original publishers.</div>
</footer>

<!-- Floating refresh -->
<div class="floating">
  <button id="refresh" class="btn" type="button">Refresh</button>
</div>

<script>
/* ---------------- Data & helpers ---------------- */
const FEEDS = [
  "https://www.tdworld.com/rss",
  "https://www.utilitydive.com/feeds/news/",
  "https://feeds.reuters.com/reuters/energy",
  "https://www.powermag.com/feed/",
  "https://www.ieee-pes.org/feed/"
];
let shortMap = {};   // { originalLink: "slug" }
let ALL = [];        // normalized stories
let FILTER = "all";

const $ = (id)=>document.getElementById(id);
const strip = (h)=>{ const d=document.createElement("div"); d.innerHTML=h; return d.textContent||d.innerText||""; };
const ago = (date)=>{ const d=new Date(date); if(isNaN(d)) return ""; const s=(Date.now()-d)/1e3;
  if(s<60) return "just now"; const m=Math.floor(s/60); if(m<60) return m+" min ago";
  const h=Math.floor(m/60); if(h<24) return h+" h ago"; return Math.floor(h/24)+" d ago"; };

async function loadShortMap(){
  try{
    const r = await fetch("data/shortlinks.json", {cache:"no-store"});
    if(r.ok) shortMap = await r.json();
  }catch(e){}
}

function internalURL(it){
  const t=encodeURIComponent(it.title||""); const u=encodeURIComponent(it.link||"#");
  const d=encodeURIComponent(strip(it.desc||"").slice(0,280));
  const i=encodeURIComponent(it.img||""); const g=encodeURIComponent(it.tag||"news");
  const p=encodeURIComponent(it.pubDate||"");
  return `article.html?t=${t}&u=${u}&d=${d}&i=${i}&g=${g}&p=${p}`;
}
function shareURL(it){
  const slug = shortMap[it.link];
  return slug ? `s/${slug}.html` : internalURL(it);
}

async function fetchRSS(url){
  const prox="https://api.allorigins.win/raw?url="+encodeURIComponent(url);
  const res=await fetch(prox); if(!res.ok) return [];
  const text=await res.text(); const xml=new DOMParser().parseFromString(text,"text/xml");
  return [...xml.querySelectorAll("item")].map(item=>{
    const title=item.querySelector("title")?.textContent?.trim()||"";
    const link=item.querySelector("link")?.textContent?.trim()||"#";
    const pubDate=item.querySelector("pubDate")?.textContent||"";
    const desc=item.querySelector("description")?.textContent||"";
    const enc=item.querySelector("content\\:encoded")?.textContent||"";
    const imgMatch=(enc||desc).match(/<img[^>]+src=["']([^"']+)["']/i);
    const img=imgMatch?imgMatch[1]:"";
    const k=(title+" "+desc).toLowerCase();
    let tag="grid";
    if(k.includes("substation")||k.includes("switchgear")) tag="substation";
    else if(k.includes("relay")||k.includes("protection")||k.includes("iec")) tag="protection";
    else if(k.includes("cable")||k.includes("xlpe")) tag="cable";
    else if(k.includes("hvdc")) tag="hvdc";
    else if(k.includes("policy")||k.includes("tariff")||k.includes("regulat")) tag="policy";
    else if(k.includes("renewable")||k.includes("solar")||k.includes("wind")) tag="renewable";
    return {title,link,pubDate,desc,img,tag};
  });
}

async function loadAll(){
  const sets=await Promise.allSettled(FEEDS.map(fetchRSS));
  const tmp=[]; for(const s of sets){ if(s.status==="fulfilled") tmp.push(...s.value); }
  const seen=new Set(), uniq=[];
  for(const it of tmp){ if(!seen.has(it.link)){ seen.add(it.link); uniq.push(it); } }
  uniq.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
  ALL = uniq;
  $("updated").textContent="Updated — "+new Date().toLocaleString();
}

/* ---------------- Rendering ---------------- */
function applyFilter(arr){ return FILTER==="all" ? arr : arr.filter(x=>x.tag===FILTER); }

function renderLead(list){
  if(!list.length){ $("leadTitle").textContent="No news available."; return; }
  const L=list[0];
  $("leadTitle").textContent=L.title;
  $("leadDek").textContent=strip(L.desc).slice(0,240);
  $("leadImg").src=L.img || "https://placehold.co/1000x180/png?text=PTD+Today";
  $("leadMeta").textContent=(L.tag.toUpperCase())+" • "+(L.pubDate?ago(L.pubDate):"");
  $("leadOpen").href=internalURL(L);
  $("leadSource").href=L.link;
  $("leadShare").onclick=()=>{
    const u=(location.origin+"/"+shareURL(L)).replace(/\/+/g,"/");
    if(navigator.share){ navigator.share({title:L.title,text:strip(L.desc).slice(0,160),url:u}).catch(()=>{}); }
    else window.open("https://www.linkedin.com/sharing/share-offsite/?url="+encodeURIComponent(u), "_blank");
  };
  $("leadTitle").onclick=()=>location.href=internalURL(L);
  $("leadImg").style.cursor="pointer"; $("leadImg").onclick=()=>location.href=internalURL(L);
}

function renderFeed(list){
  const el=$("feed"); el.innerHTML="";
  list.slice(1).forEach(it=>{
    const card=document.createElement("article"); card.className="card";
    const internal=internalURL(it); const share=shareURL(it);
    card.innerHTML=`
      <h3><a href="${internal}">${it.title}</a></h3>
      <img class="thumb" ${it.img ? `src="${it.img}"` : 'style="display:none"'} alt="">
      <div class="dek">${strip(it.desc).slice(0,180)}</div>
      <div class="meta">${it.tag.toUpperCase()} • ${it.pubDate?ago(it.pubDate):""}</div>
      <div class="row">
        <a class="btn" href="${internal}">Open on PTD Today</a>
        <button class="btn share" type="button">Share</button>
        <a class="btn" href="${it.link}" target="_blank" rel="noopener">Source</a>
      </div>
    `;
    card.querySelector(".share").onclick=()=>{
      const u=(location.origin+"/"+share).replace(/\/+/g,"/");
      if(navigator.share){ navigator.share({title:it.title,text:strip(it.desc).slice(0,160),url:u}).catch(()=>{}); }
      else window.open("https://www.linkedin.com/sharing/share-offsite/?url="+encodeURIComponent(u), "_blank");
    };
    el.appendChild(card);
  });
}

function markActive(){ document.querySelectorAll(".tab").forEach(a=>a.setAttribute("aria-current", a.dataset.filter===FILTER?"true":"false")); }

function renderAll(){
  const view=applyFilter(ALL);
  renderLead(view);
  renderFeed(view);
  markActive();
}

/* ---------------- Interactions ---------------- */
$("refresh").onclick = async ()=>{ await loadAll(); renderAll(); };
document.getElementById("tabs").addEventListener("click",(e)=>{
  const a=e.target.closest(".tab"); if(!a) return;
  e.preventDefault(); FILTER=a.dataset.filter||"all"; renderAll();
});

/* ---------------- Boot ---------------- */
(async function(){
  await loadShortMap();
  await loadAll();
  renderAll();
})();
</script>
</body>
</html>
