<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PTD Today ‚Äî Daily Energy & Power News</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#dfd3bd">
<meta name="description" content="Daily Energy & Power News. First to Know. First to Lead.">
<link rel="icon" href="data:,">
<style>
  :root{
    --paper:#e6dcc7; --ink:#1c1b18; --muted:#6e675c;
    --pill:#d9ccb3;  --link:#153e9f; --card:#efe7d4; --pillOn:#eadfc8;
  }
  html,body{margin:0;background:var(--paper);color:var(--ink);font-family:Georgia,'Times New Roman',serif}
  .wrap{max-width:900px;margin:0 auto;padding:26px 18px 60px}
  header h1{font-size:56px;line-height:1.05;margin:10px 0 6px}
  header p.tag{margin:0 0 22px;color:var(--muted);font-style:italic;font-size:20px}
  h2.kicker{margin:0 0 16px;font-size:28px;letter-spacing:.3px}
  .tabs{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 18px}
  .tab{padding:10px 14px;border-radius:999px;background:var(--pill);cursor:pointer;font-weight:600}
  .tab.active{background:var(--pillOn);box-shadow:inset 0 0 0 1px rgba(0,0,0,.08)}
  .stamp{display:inline-block;background:var(--card);border-radius:999px;padding:10px 14px;margin:8px 0 18px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:22px}
  .card{display:grid;grid-template-columns:110px 1fr;gap:16px;background:var(--card);border-radius:16px;padding:16px}
  .thumb{width:110px;height:84px;border-radius:8px;background:#d7cfbb;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .meta{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
  .title{margin:0 0 8px;font-size:24px;line-height:1.15}
  .title a{color:var(--link);text-decoration:none}
  .title a:hover{text-decoration:underline}
  .actions{display:flex;flex-wrap:wrap;gap:8px}
  .btn{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:9px 14px;font-weight:600;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  footer{margin:36px 0 0;color:var(--muted);text-align:center}
  dialog{border:none;border-radius:14px;padding:0;box-shadow:0 14px 60px rgba(0,0,0,.25)}
  .sheet{padding:14px}
  .sheet h3{margin:10px 12px 8px}
  .sheet .sbtn{display:block;width:100%;text-align:left;padding:12px 14px;border:0;background:#fff}
  .sheet .sbtn + .sbtn{border-top:1px solid #eee}
  @media (max-width:560px){
    .card{grid-template-columns:88px 1fr}
    .thumb{width:88px;height:72px}
    .title{font-size:20px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>PTD Today</h1>
      <p class="tag">First to Know. First to Lead.</p>
      <h2 class="kicker">Daily Energy &amp; Power News</h2>
    </header>

    <nav class="tabs" id="tabs">
      <button class="tab active" data-cat="all">All</button>
      <button class="tab" data-cat="top">Top (7d)</button>
      <button class="tab" data-cat="grid">Grid</button>
      <button class="tab" data-cat="substations">Substations</button>
      <button class="tab" data-cat="protection">Protection</button>
      <button class="tab" data-cat="cables">Cables</button>
      <button class="tab" data-cat="hvdc">HVDC</button>
      <button class="tab" data-cat="renewables">Renewables</button>
      <button class="tab" data-cat="policy">Policy</button>
      <button class="tab" data-cat="ai">AI</button>
      <button class="tab" data-cat="datacenters">Data Centers</button>
    </nav>

    <div class="stamp" id="stamp">Updated ‚Äî</div>
    <section class="list" id="list"></section>

    <footer>¬© 2025 PTD Today ‚Ä¢ Headlines link to their original publishers.</footer>
  </div>

  <!-- Share sheet -->
  <dialog id="shareDlg">
    <div class="sheet">
      <h3>Share</h3>
      <button class="sbtn" data-share="linkedin">LinkedIn</button>
      <button class="sbtn" data-share="x">X (Twitter)</button>
      <button class="sbtn" data-share="facebook">Facebook</button>
      <button class="sbtn" data-share="reddit">Reddit</button>
      <button class="sbtn" data-share="copy">Copy link</button>
      <button class="sbtn" data-share="email">Email</button>
      <button class="sbtn" id="closeShare">Close √ó</button>
    </div>
  </dialog>

<script>
const LIST  = document.getElementById('list');
const STAMP = document.getElementById('stamp');
const TABS  = document.getElementById('tabs');
const SHARE = document.getElementById('shareDlg');

let TODAY = [];     // from /data/news.json  (your daily/weekend logic)
let WEEK  = null;   // from /data/news_7d.json (strict last 7 days)
let CURRENT = 'all';

/* ---------- Utilities ---------- */

// your weekend/day window
function computeWindow(now=new Date()){
  const d = new Date(now);
  const wd = d.getUTCDay(); // 0 Sun .. 6 Sat
  const start = new Date(d); const end = new Date(d);

  if (wd === 6){          // Saturday => Friday + Saturday
    start.setUTCDate(d.getUTCDate()-1); start.setUTCHours(0,0,0,0);
    end.setUTCHours(23,59,59,999);
  } else if (wd === 0){   // Sunday => Fri + Sat + Sun
    start.setUTCDate(d.getUTCDate()-2); start.setUTCHours(0,0,0,0);
    end.setUTCHours(23,59,59,999);
  } else if (wd === 1){   // Monday => Fri + Sat + Sun + Mon
    start.setUTCDate(d.getUTCDate()-3); start.setUTCHours(0,0,0,0);
    end.setUTCHours(23,59,59,999);
  } else {                // Tue‚ÄìFri => current day only
    start.setUTCHours(0,0,0,0);
    end.setUTCHours(23,59,59,999);
  }
  return {start,end};
}

// strict last 7 days check
function within7d(iso){
  const t = Date.parse(iso);
  return (Date.now() - t) <= 7*24*3600*1000;
}

// reliable thumbnail via proxy (prevents hotlink/CORS blocks)
function prox(u){
  if(!u) return '';
  const clean = u.replace(/^https?:\/\//,'');
  return 'https://wsrv.nl/?w=330&h=220&fit=cover&url=' + encodeURIComponent(clean);
}

function setTab(cat){
  CURRENT = cat;
  [...TABS.querySelectorAll('.tab')]
    .forEach(b => b.classList.toggle('active', b.dataset.cat===cat));
}

function openShareSheet(link){
  SHARE.showModal();
  SHARE.onclick = (e)=>{
    const btn = e.target.closest('[data-share]'); if(!btn) return;
    const what = btn.dataset.share;
    const u = encodeURIComponent(link);
    if(what==='linkedin') location.href = `https://www.linkedin.com/sharing/share-offsite/?url=${u}`;
    if(what==='x')        location.href = `https://twitter.com/intent/tweet?url=${u}`;
    if(what==='facebook') location.href = `https://www.facebook.com/sharer/sharer.php?u=${u}`;
    if(what==='reddit')   location.href = `https://www.reddit.com/submit?url=${u}`;
    if(what==='copy')     navigator.clipboard.writeText(link);
    if(what==='email')    location.href = `mailto:?subject=PTD Today&body=${u}`;
    SHARE.close();
  };
  document.getElementById('closeShare').onclick = ()=>SHARE.close();
}

function cardHTML(it){
  const thumb = it.image ? `<img src="${prox(it.image)}" alt="">` : '';
  const when  = new Date(it.date).toISOString().replace('.000Z','Z');
  return `
  <article class="card">
    <div class="thumb">${thumb || '<span style="font-size:22px;color:#7f7769">üóûÔ∏è</span>'}</div>
    <div>
      <div class="meta">${(it.category||'').toUpperCase()} ‚Ä¢ ${it.source||''} ‚Ä¢ ${when} ‚Ä¢ Score: ${Number(it.score||0).toFixed(3)}</div>
      <h3 class="title"><a href="${it.url}" target="_blank" rel="noopener">${it.title}</a></h3>
      <div class="actions">
        <a class="btn" href="${it.short || it.url}" target="_blank" rel="noopener">Open on PTD Today</a>
        <a class="btn" href="${it.url}"   target="_blank" rel="noopener">Source</a>
        <button class="btn" data-share="${it.short || it.url}">Share</button>
      </div>
    </div>
  </article>`;
}

function render(cat){
  let base = (cat==='top' && Array.isArray(WEEK)) ? WEEK : TODAY;
  let view = base.slice();

  if (cat==='top'){
    // Use WEEK; if WEEK is absent, fall back to strict 7d from TODAY
    if (!Array.isArray(WEEK)) view = TODAY.filter(x => within7d(x.date));
    view = view.sort((a,b)=> (b.score||0)-(a.score||0));
  } else {
    // category filter
    if (cat!=='all'){
      const want = cat.toLowerCase();
      view = view.filter(x => (x.category||'').toLowerCase() === want);
    }
    // enforce your daily/weekend window on TODAY set
    const {start,end} = computeWindow(new Date());
    const lo = start.getTime(), hi = end.getTime();
    view = view.filter(x=> {
      const t = Date.parse(x.date);
      return t>=lo && t<=hi;
    }).sort((a,b)=> Date.parse(b.date)-Date.parse(a.date));
  }

  LIST.innerHTML = view.length
    ? view.map(cardHTML).join('')
    : `<p style="color:#6e675c;text-align:center;margin:40px 0;">No stories found.</p>`;

  LIST.querySelectorAll('button[data-share]').forEach(b=>{
    b.addEventListener('click', ()=>openShareSheet(b.dataset.share));
  });
}

/* ---------- Boot ---------- */
(async function(){
  try{
    // load today's window
    const res  = await fetch('/data/news.json', {cache:'no-store'});
    const data = await res.json();
    TODAY = Array.isArray(data.items) ? data.items : [];
    STAMP.textContent = 'Updated ‚Äî ' + (data.updated || new Date().toISOString());

    // opportunistically load 7d file
    try{
      const r7  = await fetch('/data/news_7d.json', {cache:'no-store'});
      if (r7.ok){
        const d7 = await r7.json();
        if (Array.isArray(d7.items)) WEEK = d7.items;
      }
    }catch(_){ /* optional */ }

    // Initial render (deep link support ?cat=grid)
    const url  = new URL(location.href);
    const deep = (url.searchParams.get('cat') || 'all').toLowerCase();
    setTab(deep);
    render(deep);

    // Tab switching
    TABS.addEventListener('click', ev=>{
      const b = ev.target.closest('.tab'); if(!b) return;
      const cat = b.dataset.cat;
      setTab(cat);
      history.replaceState(null,'', cat==='all' ? location.pathname : `?cat=${cat}`);
      render(cat);
    });

  }catch(err){
    console.error(err);
    STAMP.textContent = 'Updated ‚Äî error loading /data/news.json';
    LIST.innerHTML = `<p style="color:#a00;text-align:center">Could not load news.json. Ensure it exists and is valid JSON.</p>`;
  }
})();
</script>
</body>
</html>