<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PTD Today â€” Daily Energy & Power News</title>

<!-- Look & feel (WSJ-ish, centered, compact thumbs) -->
<style>
  :root{
    --paper:#e8dfcf;        /* page background */
    --sheet:#fbf7ef;        /* story card */
    --ink:#20170f;          /* text */
    --ink-soft:#6b5e4b;
    --accent:#0b3d91;       /* title links */
    --pill:#dbcfb9;
    --pill-active:#c2b49b;
    --ring:#b6a88f;
  }
  html,body{margin:0;padding:0}
  body{
    font-family: Georgia, "Times New Roman", serif;
    background: radial-gradient(1200px 400px at 50% -10%, #efe7d8, var(--paper));
    color: var(--ink);
  }
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px}
  header{margin:8px 0 8px 0;text-align:left}
  h1{font-size:56px;letter-spacing:.5px;margin:6px 0 2px}
  .tag{margin:0 0 18px 2px;color:var(--ink-soft);font-style:italic}
  h2{font-size:28px;margin:0 0 10px}
  /* tabs */
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 8px}
  .tab{
    border:0;cursor:pointer;font-weight:700;
    padding:8px 14px;border-radius:22px;background:var(--pill);
  }
  .tab[aria-selected="true"]{background:var(--pill-active)}
  /* updated pill */
  .stamp{display:inline-block;margin:8px 0 14px;padding:8px 12px;border-radius:18px;
    background:var(--sheet);box-shadow:0 0 0 1px var(--ring) inset;color:var(--ink-soft)}
  /* stories */
  .list{display:flex;flex-direction:column;gap:14px;margin:0;padding:0;list-style:none}
  .card{
    display:grid;grid-template-columns:88px 1fr;gap:14px;align-items:start;
    background:var(--sheet);border-radius:10px;padding:12px 12px 10px;
    box-shadow:0 1px 0 rgba(0,0,0,.05), 0 0 0 1px #e4dcca inset;
  }
  .thumb{
    width:88px;height:88px;border-radius:6px;object-fit:cover;background:#d9d2c3;
  }
  .kicker{font-size:12px;letter-spacing:.08em;color:var(--ink-soft);margin:2px 0 6px}
  .title{margin:0 0 6px}
  .title a{color:var(--accent);text-decoration:none}
  .meta{font-size:13px;color:var(--ink-soft);margin:2px 0 4px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .btn{
    appearance:none;border:1px solid var(--ring);background:var(--paper);
    border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:600;
  }
  .btn:hover{background:#efe6d6}
  .muted{opacity:.85}
  footer{color:var(--ink-soft);font-size:13px;text-align:center;margin:20px 0 8px}
  /* share modal */
  .sheet{
    position:fixed;left:0;right:0;bottom:-100%;z-index:50;background:var(--sheet);
    box-shadow:0 -12px 24px rgba(0,0,0,.15);border-top-left-radius:16px;border-top-right-radius:16px;
    transition:bottom .25s ease;max-width:980px;margin:0 auto
  }
  .sheet.open{bottom:0}
  .sheet .hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eadfcf}
  .sheet h3{margin:0;font-size:18px}
  .share-list{display:flex;flex-direction:column;margin:6px 0 10px}
  .share-list a,.share-list button{
    text-align:left;padding:14px 16px;border:0;background:transparent;border-bottom:1px solid #efe4d3;
    font-size:16px;cursor:pointer
  }
  .close{color:#6b5e4b;background:transparent;border:0;font-size:16px;cursor:pointer}
  /* responsive */
  @media (max-width:560px){
    h1{font-size:44px}
    .card{grid-template-columns:76px 1fr}
    .thumb{width:76px;height:76px}
  }
</style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>PTD Today</h1>
      <div class="tag">First to Know. First to Lead.</div>
      <h2>Daily Energy & Power News</h2>
    </header>

    <!-- Tabs -->
    <nav class="tabs" id="tabs" role="tablist" aria-label="Categories">
      <button class="tab" role="tab" aria-selected="true" data-cat="all">All</button>
      <button class="tab" role="tab" data-cat="top7">Top (7d)</button>
      <button class="tab" role="tab" data-cat="grid">Grid</button>
      <button class="tab" role="tab" data-cat="substations">Substations</button>
      <button class="tab" role="tab" data-cat="protection">Protection</button>
      <button class="tab" role="tab" data-cat="cables">Cables</button>
      <button class="tab" role="tab" data-cat="hvdc">HVDC</button>
      <button class="tab" role="tab" data-cat="renewables">Renewables</button>
      <button class="tab" role="tab" data-cat="policy">Policy</button>
      <button class="tab" role="tab" data-cat="ai">AI</button>
      <button class="tab" role="tab" data-cat="datacenters">Data Centers</button>
    </nav>

    <div class="stamp" id="stamp">Updated â€” â€¦</div>

    <!-- Stories -->
    <ul class="list" id="list"></ul>

    <footer>Â© 2025 PTD Today â€¢ Headlines link to their original publishers.</footer>
  </div>

  <!-- Share modal -->
  <div class="sheet" id="shareSheet" aria-hidden="true">
    <div class="hdr">
      <h3>Share</h3>
      <button class="close" id="shareClose">Close Ã—</button>
    </div>
    <div class="share-list" id="shareList">
      <!-- populated by JS -->
    </div>
  </div>

<script>
/* ============================================================
   Helpers
============================================================ */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const LIST = $('#list');
const STAMP = $('#stamp');
const SHEET = $('#shareSheet');
const SHARE_LIST = $('#shareList');
const SHARE_CLOSE = $('#shareClose');

// Safe accessors
const safe = (v, d='') => (v===undefined||v===null)?d:v;
const fmtNum = n => (typeof n==='number' ? n.toFixed(3) : safe(n,''));
const toISO = v => {
  try { return new Date(v).toISOString(); } catch(e){ return ''; }
};

// Compute TODAY window by rule we agreed
function todayWindow(now = new Date()){
  const day = now.getDay(); // 0 Sun .. 6 Sat
  const start = new Date(now); start.setHours(0,0,0,0);
  const end   = new Date(now); end.setHours(23,59,59,999);

  const addDays = (d, n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };

  let from = new Date(start), to = new Date(end);

  if (day===6){            // Saturday: Fri+Sat
    from = addDays(start,-1);
  } else if (day===0){     // Sunday: Fri+Sat+Sun
    from = addDays(start,-2);
  } else if (day===1){     // Monday: Fri..Mon
    from = addDays(start,-3);
  } else if (day===2){     // Tuesday: Mon+Tue
    from = addDays(start,-1);
  } else {                 // Wed/Thu/Fri: just today
    // from already today
  }
  return {from, to};
}

function sevenDaysWindow(now = new Date()){
  const to   = new Date(now); to.setHours(23,59,59,999);
  const from = new Date(now); from.setDate(from.getDate()-6); from.setHours(0,0,0,0);
  return {from, to};
}

function inRange(d, from, to){
  const t = new Date(d).getTime();
  return t>=from.getTime() && t<=to.getTime();
}

function catMatch(itemCat, wanted){
  if (!wanted || wanted==='all') return true;
  if (wanted==='top7') return true;
  return (safe(itemCat,'').toLowerCase() === wanted);
}

function buildShareTargets(title, ptdUrl){
  // Use ptdUrl only (as requested) â€” point everything to PTD link
  const encT = encodeURIComponent(title);
  const encU = encodeURIComponent(ptdUrl);
  return [
    {label:'LinkedIn',  href:`https://www.linkedin.com/sharing/share-offsite/?url=${encU}`},
    {label:'X (Twitter)', href:`https://twitter.com/intent/tweet?text=${encT}&url=${encU}`},
    {label:'Facebook', href:`https://www.facebook.com/sharer/sharer.php?u=${encU}`},
    {label:'Reddit',   href:`https://www.reddit.com/submit?url=${encU}&title=${encT}`},
    {label:'Copy link', action:'copy'},
    {label:'Email',    href:`mailto:?subject=${encT}&body=${encU}`}
  ];
}

function openShare(title, ptdUrl){
  SHARE_LIST.innerHTML = '';
  const targets = buildShareTargets(title, ptdUrl);
  targets.forEach(t=>{
    if (t.action==='copy'){
      const b = document.createElement('button');
      b.textContent = 'Copy link';
      b.onclick = async ()=>{ try{ await navigator.clipboard.writeText(ptdUrl); alert('Link copied: ' + ptdUrl); }catch(e){ prompt('Copy link:', ptdUrl); } };
      SHARE_LIST.appendChild(b);
    } else {
      const a = document.createElement('a');
      a.textContent = t.label;
      a.href = t.href; a.target = '_blank'; a.rel = 'noopener';
      SHARE_LIST.appendChild(a);
    }
  });
  SHEET.classList.add('open');
  SHEET.setAttribute('aria-hidden','false');
}
SHARE_CLOSE.addEventListener('click', ()=>{ SHEET.classList.remove('open'); SHEET.setAttribute('aria-hidden','true'); });

/* ============================================================
   Fetch + Render
============================================================ */
let ALL_ITEMS = [];

async function fetchNews(){
  const res = await fetch('/data/news.json?ts=' + Date.now());
  const data = await res.json().catch(()=>({}));
  STAMP.textContent = 'Updated â€” ' + (data.updated || new Date().toISOString());
  ALL_ITEMS = Array.isArray(data.items) ? data.items : [];
}

function thumbOf(it){
  // Prefer item.image; otherwise try OG fallback from source; else placeholder
  const ph = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88"><rect width="100%" height="100%" fill="%23d9d2c3"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="%237a6e5a">ðŸ“°</text></svg>';
  return safe(it.image, ph);
}

function ptdLinkOf(it){
  // Use item.short if present; else /s/<id>.html if id exists; else fallback to source
  if (it.short) return it.short;
  if (it.id)    return '/s/' + it.id + '.html';
  return it.link || '#';
}

function render(cat){
  LIST.innerHTML = '';

  // choose time window
  const now = new Date();
  let items = [...ALL_ITEMS];

  if (cat === 'top7'){
    const win = sevenDaysWindow(now);
    items = items.filter(it => inRange(it.date, win.from, win.to));
  } else {
    // "All" and any category use TODAY-window rule
    const win = todayWindow(now);
    items = items.filter(it => inRange(it.date, win.from, win.to));
  }

  // category filter (except for top7 which already set above)
  if (cat && cat !== 'all' && cat !== 'top7'){
    items = items.filter(it => catMatch(it.category, cat));
  }

  // Sort newest first
  items.sort((a,b)=> new Date(b.date) - new Date(a.date));

  if (items.length === 0){
    LIST.innerHTML = '<li class="muted" style="text-align:center;padding:24px 6px">No stories found.</li>';
    return;
  }

  for (const it of items){
    const li = document.createElement('li');
    li.className = 'card';

    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = thumbOf(it);
    img.alt = 'thumbnail';

    // robust error fallback if remote thumbs block hotlinking
    img.onerror = ()=>{ img.src = thumbOf({}); };

    const body = document.createElement('div');
    const kicker = document.createElement('div');
    kicker.className = 'kicker';
    const catText = safe(it.category,'').toUpperCase();
    const srcText = safe(it.source,'').replace(/^www\./,'');
    kicker.textContent = (catText?catText+' â€¢ ':'') + (srcText||'') + (it.date ? ' â€¢ ' + toISO(it.date) : '');

    const h3 = document.createElement('h3');
    h3.className = 'title';
    const a = document.createElement('a');
    a.href = it.link || '#';
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = safe(it.title,'Untitled');
    h3.appendChild(a);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = 'Score: ' + fmtNum(it.score);

    const btns = document.createElement('div'); btns.className = 'btns';

    const openPtd = document.createElement('a');
    openPtd.className = 'btn';
    openPtd.textContent = 'Open on PTD Today';
    openPtd.href = ptdLinkOf(it);
    openPtd.target = '_blank'; openPtd.rel='noopener';

    const sourceBtn = document.createElement('a');
    sourceBtn.className = 'btn'; sourceBtn.textContent = 'Source';
    sourceBtn.href = it.link || '#'; sourceBtn.target = '_blank'; sourceBtn.rel='noopener';

    const shareBtn = document.createElement('button');
    shareBtn.className = 'btn'; shareBtn.textContent = 'Share';
    shareBtn.addEventListener('click', ()=>{
      const shareUrl = location.origin + ptdLinkOf(it).replace(location.origin,'');
      // Prefer native share if available
      if (navigator.share){
        navigator.share({title: it.title, url: shareUrl}).catch(()=>{ openShare(it.title, shareUrl); });
      } else {
        openShare(it.title, shareUrl);
      }
    });

    btns.append(openPtd, sourceBtn, shareBtn);
    body.append(kicker, h3, meta, btns);
    li.append(img, body);
    LIST.appendChild(li);
  }
}

function setActive(cat){
  $$('#tabs .tab').forEach(b=> b.setAttribute('aria-selected', String(b.dataset.cat===cat)));
}

/* ============================================================
   Boot
============================================================ */
(async function init(){
  // Deep link by ?cat=grid or #ai
  const url = new URL(location.href);
  let cat = (url.searchParams.get('cat') || location.hash.replace('#','') || 'all').toLowerCase();

  await fetchNews();
  setActive(cat);
  render(cat);

  // tab clicks
  $$('#tabs .tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      const c = b.dataset.cat;
      setActive(c);
      history.replaceState(null,'', c==='all' ? location.pathname : `?cat=${encodeURIComponent(c)}`);
      render(c);
    });
  });

  // auto-refresh every 3h
  setInterval(async ()=>{
    await fetchNews();
    // keep current tab
    const current = $('#tabs .tab[aria-selected="true"]')?.dataset.cat || 'all';
    render(current);
  }, 3*60*60*1000);
})();
</script>
</body>
</html>