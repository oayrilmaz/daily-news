<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PTD Today — Daily Energy & Power News</title>
<link rel="icon" href="logo.svg">
<link rel="preload" href="assets/main.css" as="style">
<link rel="stylesheet" href="assets/main.css">
<meta name="description" content="Curated headlines for grid, HVDC, substations, protection & control, cables, renewables, and policy.">
</head>
<body>
<div class="container">
  <header>
    <div class="title">PTD Today</div>
    <div class="motto">First to Know. First to Lead.</div>
    <div class="kicker">Daily Energy &amp; Power News</div>
  </header>

  <nav class="nav" id="tabs">
    <a data-cat="all" class="active" href="#">All</a>
    <a data-cat="top" href="#">Top (7d)</a>
    <a data-cat="grid" href="#">Grid</a>
    <a data-cat="substations" href="#">Substations</a>
    <a data-cat="protection" href="#">Protection</a>
    <a data-cat="cables" href="#">Cables</a>
    <a data-cat="hvdc" href="#">HVDC</a>
    <a data-cat="renewables" href="#">Renewables</a>
    <a data-cat="policy" href="#">Policy</a>
  </nav>

  <div class="badge" id="updated">Updated —</div>

  <section class="list" id="list"></section>

  <footer class="footer">
    © <span id="yr"></span> PTD Today • Headlines link to their original publishers.
  </footer>
</div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const list = $('#list');
const updatedEl = $('#updated');
const yearEl = $('#yr'); yearEl.textContent = new Date().getFullYear();

let DATA = { updated:"", items:[] };

async function loadData(){
  try{
    const r = await fetch('data/news.json?v=' + Date.now());
    DATA = await r.json();
  }catch(e){
    console.error(e);
    DATA = {updated:"", items:[]};
  }
  updatedEl.textContent = 'Updated — ' + (DATA.updated||'');
  render('all');
}

function shortUrl(id){ return location.origin + '/s/' + id + '.html'; }

function cardHTML(it){
  const img = it.image || 'assets/og-default.png';
  const source = it.source || (new URL(it.url)).hostname;
  const pub = it.published ? new Date(it.published).toLocaleString() : '';
  return `
  <article class="card">
    <img loading="lazy" src="${img}" alt="">
    <div>
      <h3><a href="${shortUrl(it.id)}" target="_blank" rel="noopener">${it.title}</a></h3>
      <div class="meta">${(it.category||'').toUpperCase()} • ${source} • ${pub} ${it.score?`• Score: ${(+it.score).toFixed(3)}`:''}</div>
      <div class="actions">
        <a class="btn primary" href="${shortUrl(it.id)}" target="_blank" rel="noopener">Open on PTD Today</a>
        <a class="btn" href="${it.url}" target="_blank" rel="noopener">Source</a>
        <button class="btn" onclick="share('${it.id}','${encodeURIComponent(it.title)}')">Share</button>
      </div>
    </div>
  </article>`;
}

function render(cat){
  // category “top” = top 7 days by score (fallback to published)
  let items = DATA.items || [];
  if(cat && cat !== 'all' && cat !== 'top'){
    items = items.filter(i => (i.category||'').toLowerCase() === cat);
  }
  if(cat === 'top'){
    const now = Date.now();
    const week = 7*24*3600*1000;
    items = items.filter(i=>{
      const t = i.published ? Date.parse(i.published) : now;
      return (now - t) <= week;
    }).sort((a,b)=>(+b.score||0)-(+a.score||0));
  } else {
    items = items.sort((a,b)=>Date.parse(b.published||0)-Date.parse(a.published||0));
  }

  list.innerHTML = items.map(cardHTML).join('') || `<p>No stories in this category yet.</p>`;
}

$$('#tabs a').forEach(a=>{
  a.addEventListener('click', ev=>{
    ev.preventDefault();
    $$('#tabs a').forEach(n=>n.classList.remove('active'));
    a.classList.add('active');
    render(a.dataset.cat);
  });
});

async function share(id, encTitle){
  const title = decodeURIComponent(encTitle);
  const url = shortUrl(id);

  if(navigator.share){
    try{
      await navigator.share({ title, url });
      return;
    }catch(e){}
  }
  // copy fallback
  try{
    await navigator.clipboard.writeText(url);
    alert('Link copied: ' + url);
  }catch(e){
    prompt('Copy link:', url);
  }
}

loadData();
</script>
</body>
</html>