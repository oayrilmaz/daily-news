<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PTD Today — Daily Energy & Power News</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/assets/main.css?v=2025-10-05">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath d='M36 4 8 36h16L28 60 56 28H40L36 4z' fill='%23111'/%3E%3C/svg%3E">
<meta name="description" content="Curated daily & weekly headlines across grid, HV substations, protection & control, cables, HVDC, renewables, and policy.">
</head>
<body>

<header class="site">
  <h1 class="site-title">PTD Today</h1>
  <div class="site-motto">First to Know. First to Lead.</div>
  <div class="site-kicker">Daily Energy &amp; Power News</div>
</header>

<nav class="nav" id="nav">
  <a href="#all" class="active">All</a>
  <a href="#top">Top (7d)</a>
  <a href="#grid">Grid</a>
  <a href="#substations">Substations</a>
  <a href="#protection">Protection</a>
  <a href="#cables">Cables</a>
  <a href="#hvdc">HVDC</a>
  <a href="#renewables">Renewables</a>
  <a href="#policy">Policy</a>
</nav>

<div class="updated"><span id="updated">Updated — …</span></div>

<main class="main">
  <div id="feed"></div>
</main>

<footer class="site-foot">© 2025 PTD Today • Headlines link to their original publishers.</footer>

<!-- Share sheet (fallback if Web Share API unavailable) -->
<div class="sheet-backdrop" id="sheetBackdrop" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" role="document">
    <h3>Share</h3>
    <a id="shL" target="_blank" rel="noopener">LinkedIn</a>
    <a id="shX" target="_blank" rel="noopener">X (Twitter)</a>
    <a id="shF" target="_blank" rel="noopener">Facebook</a>
    <a id="shR" target="_blank" rel="noopener">Reddit</a>
    <button id="shC">Copy link</button>
    <button id="shE">Email</button>
    <button class="close" id="shClose">Close ×</button>
  </div>
</div>

<script>
const FEED = document.getElementById('feed');
const UPDATED = document.getElementById('updated');
const NAV = document.getElementById('nav');
const SHEET = document.getElementById('sheetBackdrop');

let ALL_ITEMS = [];
let activeHash = (location.hash || '#all').toLowerCase();

/* util */
const enc = s => encodeURIComponent(s || '');
const fmt = iso => {
  try { return new Date(iso).toLocaleString(); }
  catch(e){ return iso || ''; }
};
const daysAgo = (iso) => (Date.now() - new Date(iso).getTime())/86400000;

function shortUrl(id){ return `https://ptdtoday.com/s/${id}.html`; }

function setActiveTab(){
  [...NAV.querySelectorAll('a')].forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === activeHash);
  });
}

function cardHTML(it){
  const id = it.id || Math.random().toString(36).slice(2,8);
  const sUrl = shortUrl(id);
  const img = it.image ? it.image : '';
  const srcName = it.source || it.site || '';
  const cat = (it.category || '').toString();
  const when = it.published || it.date || '';
  const score = (it.score!=null) ? ` • Score: ${(+it.score).toFixed(3)}` : '';

  return `
  <article class="card">
    <a href="${sUrl}" aria-label="Open"><img class="thumb" src="${img}" alt=""></a>
    <div>
      <h2 class="hline"><a href="${sUrl}">${it.title || ''}</a></h2>
      <div class="meta">
        ${cat ? cat.charAt(0).toUpperCase()+cat.slice(1) : ''} •
        ${srcName ? srcName : ''} •
        ${when ? fmt(when) : ''}${score}
      </div>
      <div class="actions">
        <a class="btn" href="${sUrl}">Open on PTD Today</a>
        <a class="btn" href="${it.url}" target="_blank" rel="noopener">Source</a>
        <button class="btn" onclick='share("${id}", ${JSON.stringify(it.title || '').replace(/'/g,"&#39;")})'>Share</button>
      </div>
    </div>
  </article>`;
}

function render(){
  let list = ALL_ITEMS.slice();

  // Filter by tab
  switch(activeHash){
    case '#top':
      list = list.filter(x => x.published && daysAgo(x.published) <= 7);
      list.sort((a,b) => (b.score||0) - (a.score||0) || new Date(b.published||0)-new Date(a.published||0));
      break;
    case '#grid': list = list.filter(x => (x.category||'').toLowerCase()==='grid'); break;
    case '#substations': list = list.filter(x => (x.category||'').toLowerCase()==='substations'); break;
    case '#protection': list = list.filter(x => (x.category||'').toLowerCase()==='protection'); break;
    case '#cables': list = list.filter(x => (x.category||'').toLowerCase()==='cables'); break;
    case '#hvdc': list = list.filter(x => (x.category||'').toLowerCase()==='hvdc'); break;
    case '#renewables': list = list.filter(x => (x.category||'').toLowerCase()==='renewables'); break;
    case '#policy': list = list.filter(x => (x.category||'').toLowerCase()==='policy'); break;
    default: /* all */ break;
  }

  FEED.innerHTML = list.map(cardHTML).join('') || `<p class="meta">No stories in this category yet.</p>`;
}

function openSheet(id, title){
  // Build URLs for classic sharing with shortlink
  const u = shortUrl(id);
  document.getElementById('shL').href = `https://www.linkedin.com/sharing/share-offsite/?url=${enc(u)}&title=${enc(title)}`;
  document.getElementById('shX').href = `https://twitter.com/intent/tweet?url=${enc(u)}&text=${enc(title)}`;
  document.getElementById('shF').href = `https://www.facebook.com/sharer/sharer.php?u=${enc(u)}`;
  document.getElementById('shR').href = `https://www.reddit.com/submit?url=${enc(u)}&title=${enc(title)}`;
  document.getElementById('shC').onclick = () => { navigator.clipboard.writeText(u); closeSheet(); };
  document.getElementById('shE').onclick = () => {
    location.href = `mailto:?subject=${enc(title)}&body=${enc(u)}`;
    closeSheet();
  };
  SHEET.style.display='block';
}
function closeSheet(){ SHEET.style.display='none'; }

async function share(id, title){
  const url = shortUrl(id);
  if (navigator.share){
    try {
      await navigator.share({title, text:title, url});
    } catch(e){ /* user canceled */ }
  } else {
    openSheet(id, title);
  }
}

SHEET.addEventListener('click', (e)=>{ if(e.target===SHEET) closeSheet(); });
document.getElementById('shClose').onclick = closeSheet;

// Routing
window.addEventListener('hashchange', ()=>{
  activeHash = (location.hash || '#all').toLowerCase();
  setActiveTab(); render();
});

// Load JSON
(async function load(){
  try{
    const res = await fetch('/data/news.json', {cache:'no-store'});
    const json = await res.json();
    UPDATED.textContent = 'Updated — ' + (json.updated || new Date().toISOString());
    ALL_ITEMS = (json.items || []).map(x => ({
      id: x.id || (x.url||'').split('/').slice(-1)[0].replace(/[^a-z0-9]/gi,'').slice(0,8),
      title: x.title, url: x.url, image: x.image, source: x.source, site: x.site,
      published: x.published || x.date, category: (x.category||'').toLowerCase(),
      score: x.score
    }));
    setActiveTab(); render();
  }catch(e){
    UPDATED.textContent = 'Updated — (failed to load)';
    FEED.innerHTML = '<p class="meta">No stories found. Ensure /data/news.json is present.</p>';
  }
})();
</script>
</body>
</html>