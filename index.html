<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PTD Today — Daily Energy & Power News</title>

  <!-- OpenGraph defaults (page) -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="PTD Today">
  <meta property="og:title" content="PTD Today — Daily Energy & Power News">
  <meta property="og:description" content="First to Know. First to Lead. Curated energy, grid, HVDC, substations, protection & control, cables, policy and more.">
  <meta property="og:image" content="/assets/og-default.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='48' x='6' font-size='48' font-family='Georgia,serif'%3EPTD%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="/assets/main.css">
</head>
<body>
  <header class="masthead">
    <h1 class="brand">PTD Today</h1>
    <p class="motto">First to Know. First to Lead.</p>
    <h2 class="tagline">Daily Energy &amp; Power News</h2>
    <nav class="tabs" id="tabs">
      <button data-tab="all" class="active">All</button>
      <button data-tab="top">Top (7d)</button>
      <button data-cat="grid">Grid</button>
      <button data-cat="substations">Substations</button>
      <button data-cat="protection">Protection</button>
      <button data-cat="cables">Cables</button>
      <button data-cat="hvdc">HVDC</button>
      <button data-cat="renewables">Renewables</button>
      <button data-cat="policy">Policy</button>
    </nav>
    <div id="updated" class="updated">Updated —</div>
  </header>

  <main id="list" class="list"></main>

  <footer class="footer">
    <p>© <span id="y"></span> PTD Today • Headlines link to their original publishers.</p>
  </footer>

  <!-- Share modal (fallback when Web Share API not available) -->
  <dialog id="shareDlg">
    <div class="sheet">
      <button class="sheet-btn" data-share="linkedin">LinkedIn</button>
      <button class="sheet-btn" data-share="x">X (Twitter)</button>
      <button class="sheet-btn" data-share="facebook">Facebook</button>
      <button class="sheet-btn" data-share="reddit">Reddit</button>
      <button class="sheet-btn" id="copyBtn">Copy link</button>
      <button class="sheet-btn" id="emailBtn">Email</button>
      <button class="sheet-close">close ×</button>
    </div>
  </dialog>

  <script>
  // ------------ Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = d => new Date(d).toISOString().replace('Z','+00:00');

  function startOfUTC(date){ const d=new Date(date); d.setUTCHours(0,0,0,0); return d; }
  function addDaysUTC(date, n){ const d=new Date(date); d.setUTCDate(d.getUTCDate()+n); return d; }

  // Weekend / weekday window requested:
  // Sat => Fri+Sat, Sun => Fri+Sat+Sun, Mon => Fri..Mon, Tue => Mon+Tue, else => today only
  function todayWindow(now=new Date()){
    const day = now.getUTCDay();         // 0 Sun ... 6 Sat
    const today0 = startOfUTC(now);
    const mon0 = addDaysUTC(today0, -((day+6)%7));          // most recent Monday 00:00
    const fri0 = addDaysUTC(mon0, 4);                        // that week's Friday 00:00
    let from = today0, to = addDaysUTC(today0, 1);          // default: today 00:00..tomorrow 00:00
    if (day === 6) { from = fri0; to = addDaysUTC(today0, 1); }                 // Sat
    else if (day === 0) { from = fri0; to = addDaysUTC(today0, 1); }            // Sun
    else if (day === 1) { from = fri0; to = addDaysUTC(today0, 1); }            // Mon
    else if (day === 2) { from = mon0; to = addDaysUTC(today0, 1); }            // Tue (Mon+Tue)
    return {from, to};
  }
  function weekWindow(now=new Date()){ return {from:addDaysUTC(now,-7), to: addDaysUTC(now,1)}; }

  function inRange(ts, range){ const t=new Date(ts); return t>=range.from && t<range.to; }

  function esc(s){ return (s||'').replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  // ------------ Page state
  let DATA = {updated:null, items:[]};
  let currentTab = 'all';  // 'all' | 'top'
  let currentCat = '';     // '', or category key
  let currentShareUrl = '';

  // ------------ Rendering
  function updatedBadge(){
    $('#updated').textContent = 'Updated — ' + (DATA.updated ? fmt(DATA.updated) : '—');
  }

  function filteredItems(){
    const now = new Date();
    const range = (currentTab==='top') ? weekWindow(now) : todayWindow(now);
    return DATA.items
      .filter(it => (!currentCat || it.category===currentCat) && inRange(it.published, range))
      .sort((a,b)=> new Date(b.published)-new Date(a.published));
  }

  function storyHTML(it){
    const sUrl = `${location.origin}/s/${it.id}.html`;
    const img = it.image || '/assets/og-default.png';
    return `
      <article class="story">
        <a class="thumb" href="${sUrl}" aria-label="Open ${esc(it.title)} on PTD Today">
          <img src="${esc(img)}" loading="lazy" referrerpolicy="no-referrer" alt="">
        </a>
        <div class="txt">
          <h3 class="h"><a href="${sUrl}">${esc(it.title)}</a></h3>
          <div class="meta">${it.category.toUpperCase()} • ${esc(it.source)} • ${fmt(it.published)} • Score: ${(+it.score||0).toFixed(4)}</div>
          <div class="actions">
            <a class="btn" href="${sUrl}">Open on PTD Today</a>
            <a class="btn" href="${esc(it.url)}" rel="noopener">Source</a>
            <button class="btn outline share" data-url="${sUrl}" data-title="${esc(it.title)}">Share</button>
          </div>
        </div>
      </article>`;
  }

  function render(){
    updatedBadge();
    const items = filteredItems();
    $('#list').innerHTML = items.length ? items.map(storyHTML).join('') : `<div class="empty">No stories found.</div>`;
    // hook share buttons
    $$('.share').forEach(btn=>{
      btn.addEventListener('click',()=>{
        currentShareUrl = btn.dataset.url;
        const title = btn.dataset.title;
        if (navigator.share) {
          navigator.share({title, url: currentShareUrl}).catch(()=>{});
        } else {
          $('#shareDlg').showModal();
        }
      });
    });
  }

  // ------------ Tabs/cats
  $('#tabs').addEventListener('click', e=>{
    const b = e.target.closest('button'); if(!b) return;
    $$('#tabs button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentTab = b.dataset.tab || currentTab;
    currentCat = b.dataset.cat || '';
    render();
  });

  // ------------ Share sheet actions
  $('#copyBtn').onclick = async() => {
    try { await navigator.clipboard.writeText(currentShareUrl); } catch {}
    $('#shareDlg').close();
  };
  $('#emailBtn').onclick = ()=>{
    location.href = `mailto:?subject=${encodeURIComponent('PTD Today: ')}&body=${encodeURIComponent(currentShareUrl)}`;
    $('#shareDlg').close();
  };
  $('#shareDlg').addEventListener('click', e=>{
    if (e.target.classList.contains('sheet-close')) $('#shareDlg').close();
    const t = e.target.dataset.share;
    if (!t) return;
    const u = encodeURIComponent(currentShareUrl);
    const title = encodeURIComponent('PTD Today');
    const social = {
      linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${u}`,
      x:        `https://twitter.com/intent/tweet?url=${u}&text=${title}`,
      facebook: `https://www.facebook.com/sharer/sharer.php?u=${u}`,
      reddit:   `https://www.reddit.com/submit?url=${u}&title=${title}`
    };
    window.open(social[t], '_blank','noopener');
    $('#shareDlg').close();
  });

  // ------------ Load data and start
  (async function init(){
    $('#y').textContent = new Date().getUTCFullYear();
    try {
      const res = await fetch('/data/news.json', {cache:'no-store'});
      DATA = await res.json();
    } catch(e){ DATA = {updated:null, items:[]}; }
    render();
  })();
  </script>
</body>
</html>