<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PTD Today — Daily Energy & Power News</title>
<link rel="icon" href="data:,">
<link rel="preload" href="assets/main.css" as="style">
<link rel="stylesheet" href="assets/main.css">

<!-- Social preview for the home page -->
<meta property="og:title" content="PTD Today — Daily Energy & Power News">
<meta property="og:description" content="First to Know. First to Lead. Curated daily headlines for grid, substations, protection & control, cables, HVDC, renewables, and policy.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://ptdtoday.com/">
<meta property="og:image" content="https://ptdtoday.com/assets/og-default.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PTD Today — Daily Energy & Power News">
<meta name="twitter:image" content="https://ptdtoday.com/assets/og-default.png">
</head>
<body>
<header class="site">
  <h1 class="brand">PTD Today</h1>
  <p class="motto">First to Know. First to Lead.</p>
  <h2 class="kicker">Daily Energy & Power News</h2>

  <nav class="tabs" id="tabs">
    <button data-tab="all" class="active">All</button>
    <button data-tab="top">Top (7d)</button>
    <button data-tab="Grid">Grid</button>
    <button data-tab="Substations">Substations</button>
    <button data-tab="Protection">Protection</button>
    <button data-tab="Cables">Cables</button>
    <button data-tab="HVDC">HVDC</button>
    <button data-tab="Renewables">Renewables</button>
    <button data-tab="Policy">Policy</button>
  </nav>

  <div class="updated" id="updated">Updated — …</div>
</header>

<main class="wrap">
  <ul id="list" class="stories" aria-live="polite"></ul>
</main>

<footer class="foot wrap">
  <p>© <span id="year"></span> PTD Today • Headlines link to their original publishers.</p>
</footer>

<script>
const $ = sel => document.querySelector(sel);
const list = $('#list');
const updatedEl = $('#updated');
$('#year').textContent = new Date().getFullYear();

// Weekend/weekday logic for the "Today" (All tab) view
function inTodayWindow(iso){
  const d = new Date();
  const dow = d.getDay(); // 0 Sun, 6 Sat
  const pub = new Date(iso);

  // start/end defaults = today 00:00..23:59
  let start = new Date(d); start.setHours(0,0,0,0);
  let end   = new Date(d); end.setHours(23,59,59,999);

  // Your rules:
  // Sat: Fri + Sat
  // Sun: Fri + Sat + Sun
  // Mon: Fri + Sat + Sun + Mon
  // Tue+: the day itself (Tue shows Mon+Tue per earlier, but we keep it “today only” to avoid double counting in Top 7d)
  if (dow === 6) { // Sat
    start.setDate(start.getDate()-1);
  } else if (dow === 0) { // Sun
    start.setDate(start.getDate()-2);
  } else if (dow === 1) { // Mon
    start.setDate(start.getDate()-3);
  }
  return pub >= start && pub <= end;
}

function isTop7d(iso){
  const pub = new Date(iso);
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
  return pub >= cutoff;
}

function storyHTML(it){
  const short = `s/${it.id}.html`;
  const img = it.image || 'assets/og-default.png';
  const date = new Date(it.published);
  const host = it.source || new URL(it.url).hostname;

  return `
<li class="story">
  <a class="thumb" href="${short}" title="Open: ${it.title}">
    <img loading="lazy" src="${img}" alt="" onerror="this.src='assets/og-default.png'">
  </a>
  <div class="meta">
    <a class="t" href="${short}">${it.title}</a>
    <div class="by">
      <span class="cat">${it.category}</span>
      <span>•</span>
      <span class="src">${host}</span>
      <span>•</span>
      <time datetime="${it.published}">${date.toISOString().replace('T',' ').slice(0,16)}</time>
      <span>• Score: ${it.score.toFixed(4)}</span>
    </div>
    <div class="actions">
      <a class="btn" href="${short}">Open on PTD Today</a>
      <a class="btn ghost" href="${it.url}" target="_blank" rel="noopener">Source</a>
      <button class="btn light" data-share="${it.id}">Share</button>
    </div>
  </div>
</li>`;
}

function attachShareHandlers(){
  document.querySelectorAll('button[data-share]').forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute('data-share');
      const url = new URL(location.href);
      url.pathname = `/s/${id}.html`;

      if (navigator.share) {
        try {
          await navigator.share({title:'PTD Today', text:'Read on PTD Today', url: url.toString()});
          return;
        } catch(e){}
      }
      // fallback
      navigator.clipboard.writeText(url.toString()).then(()=>{
        btn.textContent='Link copied';
        setTimeout(()=>btn.textContent='Share',1200);
      });
    };
  });
}

async function load(){
  try{
    const res = await fetch('data/news.json', {cache:'no-store'});
    if(!res.ok) throw new Error('news.json missing');
    const data = await res.json();
    updatedEl.textContent = 'Updated — ' + data.updated;

    const tabs = $('#tabs').querySelectorAll('button');
    const render = (mode) => {
      let items = data.items.slice(); // copy
      if (mode === 'top') items = items.filter(it=>isTop7d(it.published));
      if (['Grid','Substations','Protection','Cables','HVDC','Renewables','Policy'].includes(mode)) {
        items = items.filter(it=>it.category===mode && isTop7d(it.published));
      }
      if (mode === 'all'){ items = items.filter(it=>inTodayWindow(it.published)); }

      list.innerHTML = items.length ? items.map(storyHTML).join('') :
        `<li class="empty">No stories found.</li>`;
      attachShareHandlers();
    };

    tabs.forEach(b=>{
      b.onclick = ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        render(b.dataset.tab);
      };
    });

    render('all'); // default view per your request (Today window)
  }catch(e){
    list.innerHTML = `<li class="empty">Tip: ensure <code>/data/news.json</code> exists with { updated, items:[...] }.</li>`;
  }
}
load();
</script>
</body>
</html>