<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTD Today — Daily Energy & Power News</title>
  <meta name="description" content="Daily news for grid, substations, protection & control, cables, HVDC, renewables, and policy." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
  <style>
    :root{
      --ink:#111; --muted:#666; --line:#e6e6e6;
      --bg:#fff; --pad:16px; --max:980px;
      --btn-bg:#f7f7f7; --btn-ink:#222;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:#2416b9;text-decoration:none}
    a:hover{text-decoration:underline}
    header{max-width:var(--max);margin:32px auto 8px;padding:0 var(--pad)}
    h1{font:700 44px/1.05 "Georgia", "Times New Roman", serif;margin:0 0 6px}
    .motto{color:var(--muted);font-size:14px;margin:0 0 14px}
    h2{font:700 24px/1.2 "Georgia","Times New Roman",serif;margin:0 0 8px}
    nav.tabs{max-width:var(--max);margin:6px auto;border-bottom:1px solid var(--line);display:flex;gap:18px;flex-wrap:wrap;padding:0 var(--pad)}
    nav.tabs a{display:inline-block;padding:10px 0 14px;color:var(--btn-ink)}
    nav.tabs a.active{font-weight:700;box-shadow:0 2px 0 #000 inset}
    .updated{max-width:var(--max);margin:10px auto 0;padding:0 var(--pad)}
    .updated .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:20px;padding:6px 10px;color:var(--muted);font-size:13px;background:#fafafa}
    main{max-width:var(--max);margin:18px auto;padding:0 var(--pad)}
    .item{display:grid;grid-template-columns:120px 1fr;gap:14px;padding:16px 0;border-bottom:1px solid var(--line)}
    .item img{width:120px;height:90px;object-fit:cover;border:1px solid var(--line);background:#fff}
    .meta{color:var(--muted);font-size:13px;margin:6px 0 10px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:var(--btn-bg);color:var(--btn-ink);padding:8px 12px;border-radius:8px;font-size:14px;text-decoration:none;cursor:pointer}
    .empty{color:var(--muted);padding:40px 0;font-style:italic}
    footer{max-width:var(--max);margin:48px auto 24px;padding:0 var(--pad);color:var(--muted);font-size:14px}
    /* share modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
    .modal.open{display:flex}
    .card{width:min(520px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:8px}
    .share-title{margin:6px 10px 10px;font:600 16px/1.2 system-ui}
    .share-list{display:flex;flex-direction:column;gap:8px;padding:0 8px 10px}
    .share-list a,.share-list button{display:block;width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;text-align:left;font-size:15px;color:#111;cursor:pointer}
    .share-close{display:block;margin:4px auto 8px;color:#444}
    @media (max-width:640px){
      .item{grid-template-columns:96px 1fr}
      .item img{width:96px;height:72px}
      h1{font-size:36px}
    }
  </style>
</head>
<body>
  <header>
    <h1>PTD Today</h1>
    <p class="motto">First to Know. First to Lead.</p>
    <h2>Daily Energy &amp; Power News</h2>
  </header>

  <nav class="tabs" id="tabs">
    <a data-tab="all" class="active">All</a>
    <a data-tab="top">Top (7d)</a>
    <a data-tab="grid">Grid</a>
    <a data-tab="substations">Substations</a>
    <a data-tab="protection">Protection</a>
    <a data-tab="cables">Cables</a>
    <a data-tab="hvdc">HVDC</a>
    <a data-tab="renewables">Renewables</a>
    <a data-tab="policy">Policy</a>
  </nav>

  <div class="updated"><span class="chip" id="updated">Updated —</span></div>

  <main id="list"></main>

  <footer>
    © <span id="year"></span> PTD Today • Headlines link to their original publishers.
  </footer>

  <!-- Share modal -->
  <div class="modal" id="shareModal" aria-hidden="true">
    <div class="card">
      <div class="share-title" id="shareTitle">Share</div>
      <div class="share-list">
        <a id="shareLinkedIn" target="_blank" rel="noopener">LinkedIn</a>
        <a id="shareX" target="_blank" rel="noopener">X (Twitter)</a>
        <a id="shareFB" target="_blank" rel="noopener">Facebook</a>
        <a id="shareReddit" target="_blank" rel="noopener">Reddit</a>
        <button id="copyLink">Copy link</button>
        <a id="shareEmail">Email</a>
      </div>
      <a class="share-close" href="#" id="shareClose">Close ✕</a>
    </div>
  </div>

<script>
(() => {
  const listEl = document.getElementById('list');
  const tabsEl = document.getElementById('tabs');
  const updatedEl = document.getElementById('updated');
  document.getElementById('year').textContent = new Date().getFullYear();

  // ---- CATEGORY NORMALIZATION + AUTO-CLASSIFY -----------------------------
  const KNOWN = ['all','top','grid','substations','protection','cables','hvdc','renewables','policy'];

  const KEYWORDS = {
    grid:       /grid|transmission|interconnector|substation|line(s)?\b|synchro|iso\b|rto\b|distribution/i,
    substations:/substation|transformer|switchgear|breaker|busbar|relay|protection panel/i,
    protection: /protection|relay|iec 61850|fault|arc flash|scada|cyber|protection & control|p&amp;c/i,
    cables:     /cable|hv cable|xlpe|subsea|underground|overhead conductor|ampacity/i,
    hvdc:       /\bhvdc\b|converter station|lcc\b|vsc\b|intertie/i,
    renewables: /renewable|wind|solar|pv|hydrogen|geothermal|battery|storage|bess|offshore|clean energy/i,
    policy:     /policy|regulation|federal|ferc|doe\b|iea\b|epri\b|incentive|tariff|rto\b|market rule/i
  };

  function normalizeCategory(raw){
    if (!raw) return '';
    return String(raw).trim().toLowerCase();
  }

  function autoCategory(title, summary){
    const text = `${title || ''} ${summary || ''}`;
    for (const [cat, rx] of Object.entries(KEYWORDS)){
      if (rx.test(text)) return cat;
    }
    return ''; // remains uncategorized; will still appear under “All”
  }

  // ---- RENDER --------------------------------------------------------------
  let STATE = {
    items: [],
    tab: 'all'
  };

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      if (isNaN(d)) return '';
      return d.toISOString().replace('T',' ').substring(0,19) + 'Z';
    }catch(e){ return ''; }
  }

  function score7d(item){
    // naive freshness score used for “Top (7d)”
    const now = Date.now();
    const t = Date.parse(item.published || item.date || item.updated || 0) || now;
    const ageDays = Math.max(0,(now - t)/(1000*60*60*24));
    const clicks = Number(item.clicks || 0); // optional if you add later
    return (item.score || 0) + clicks*0.1 + Math.max(0,7-ageDays)*0.8;
  }

  function ptLink(item){
    // link to your wrapper page on PTD; this is what “Copy link” and modal share use
    const u = encodeURIComponent(item.url);
    const t = encodeURIComponent(item.title||'');
    const i = encodeURIComponent(item.image||'');
    return `${location.origin}/article.html?u=${u}&t=${t}&i=${i}`;
  }

  function shareModal(item){
    const modal = document.getElementById('shareModal');
    const title = item.title || 'PTD Today';
    const url = ptLink(item);

    document.getElementById('shareTitle').textContent = `Share: ${title}`;
    document.getElementById('shareLinkedIn').href =
      `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
    document.getElementById('shareX').href =
      `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
    document.getElementById('shareFB').href =
      `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    document.getElementById('shareReddit').href =
      `https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
    document.getElementById('shareEmail').href =
      `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(url)}`;
    document.getElementById('copyLink').onclick = async () => {
      try{
        await navigator.clipboard.writeText(url);
        alert('Link copied:\n' + url);
      }catch(e){
        prompt('Copy this link:', url);
      }
    };

    document.getElementById('shareClose').onclick = (e)=>{ e.preventDefault(); modal.classList.remove('open'); };
    modal.classList.add('open');
    modal.onclick = (e)=>{ if(e.target===modal) modal.classList.remove('open'); };
  }

  function render(){
    const tab = STATE.tab;
    let data = STATE.items.slice();

    if (tab !== 'all' && tab !== 'top'){
      data = data.filter(it => (it.categoryNorm || '') === tab);
    }

    if (tab === 'top'){
      const cutoff = Date.now() - 7*24*3600*1000;
      data = data.filter(it => (Date.parse(it.published||it.date||it.updated||0)||0) >= cutoff)
                 .sort((a,b)=> score7d(b)-score7d(a));
    }

    listEl.innerHTML = '';
    if (!data.length){
      listEl.innerHTML = `<div class="empty">No stories in this category yet.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    for (const it of data){
      const row = document.createElement('div');
      row.className = 'item';

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.src = it.image || '/assets/og-default.png';
      img.alt = '';
      row.appendChild(img);

      const right = document.createElement('div');

      const h = document.createElement('a');
      h.href = it.url;
      h.target = '_blank';
      h.rel = 'noopener';
      h.innerHTML = `<strong>${it.title || 'Untitled'}</strong>`;
      right.appendChild(h);

      if (it.summary){
        const p = document.createElement('div');
        p.textContent = it.summary;
        p.style.marginTop = '4px';
        right.appendChild(p);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      const catLabel = (it.categoryNorm && it.categoryNorm[0].toUpperCase()+it.categoryNorm.slice(1)) || 'General';
      const src = it.source || new URL(it.url).hostname.replace(/^www\./,'');
      meta.textContent = `${catLabel} • ${fmtDate(it.published || it.date || it.updated || '')} • ${src}`;
      right.appendChild(meta);

      const rowBtns = document.createElement('div');
      rowBtns.className = 'btnrow';

      const openBtn = document.createElement('a');
      openBtn.className = 'btn';
      openBtn.href = ptLink(it);
      openBtn.textContent = 'Open on PTD Today';
      rowBtns.appendChild(openBtn);

      const srcBtn = document.createElement('a');
      srcBtn.className = 'btn';
      srcBtn.href = it.url;
      srcBtn.target = '_blank';
      srcBtn.rel = 'noopener';
      srcBtn.textContent = 'Source';
      rowBtns.appendChild(srcBtn);

      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn';
      shareBtn.type = 'button';
      shareBtn.textContent = 'Share';
      shareBtn.onclick = ()=> shareModal(it);
      rowBtns.appendChild(shareBtn);

      right.appendChild(rowBtns);
      row.appendChild(right);
      frag.appendChild(row);
    }
    listEl.appendChild(frag);
  }

  // ---- LOAD JSON & PREP ----------------------------------------------------
  async function load(){
    updatedEl.textContent = 'Updated — loading…';
    const res = await fetch('/data/news.json', {cache:'no-store'});
    if (!res.ok){
      listEl.innerHTML = `<div class="empty">Could not load /data/news.json (${res.status}).</div>`;
      return;
    }
    const json = await res.json();
    const items = Array.isArray(json) ? json : (json.items || []);
    const updated = (json.updated ? fmtDate(json.updated) : fmtDate(new Date().toISOString())) || '';

    // prepare items
    const ready = items.map(it => {
      const obj = {...it};
      obj.categoryNorm = normalizeCategory(obj.category);
      if (!obj.categoryNorm || !KNOWN.includes(obj.categoryNorm)){
        obj.categoryNorm = autoCategory(obj.title, obj.summary);
      }
      if (!KNOWN.includes(obj.categoryNorm)) obj.categoryNorm = ''; // still eligible for All
      return obj;
    });

    STATE.items = ready;
    updatedEl.textContent = `Updated — ${updated}`;
    render();
  }

  // ---- TABS ----------------------------------------------------------------
  tabsEl.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-tab]');
    if (!a) return;
    e.preventDefault();
    for (const el of tabsEl.querySelectorAll('a')) el.classList.remove('active');
    a.classList.add('active');
    STATE.tab = a.dataset.tab;
    render();
  });

  load();
})();
</script>
</body>
</html>