<script>
(function () {
  var DATA_URL = "/data/media.json";

  function $(id) { return document.getElementById(id); }

  function fmtUtc(iso) {
    try { return new Date(iso).toUTCString().replace("GMT", "UTC"); }
    catch (e) { return iso || ""; }
  }

  function normalize(s) { return (s || "").toString().toLowerCase(); }

  function escapeHtml(str) {
    return (str == null ? "" : String(str))
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function mediaArticleUrl(videoId) {
    return window.location.origin + "/media/" + encodeURIComponent(videoId) + ".html";
  }

  function applySearch(items, q) {
    q = normalize(q).trim();
    if (!q) return items;

    return items.filter(function (v) {
      var parts = [];
      parts.push(v && v.title ? v.title : "");
      parts.push(v && v.channel ? v.channel : "");

      var ai = v && v.ai ? v.ai : null;
      if (ai && ai.summary) parts.push(ai.summary);

      if (ai && Array.isArray(ai.bullets)) parts = parts.concat(ai.bullets);
      if (ai && Array.isArray(ai.takeaways)) parts = parts.concat(ai.takeaways);
      if (ai && Array.isArray(ai.tags)) parts = parts.concat(ai.tags);

      return normalize(parts.join(" ")).indexOf(q) !== -1;
    });
  }

  function cardHtml(v) {
    var id = (v && v.id ? String(v.id) : "").trim();
    var title = v && v.title ? String(v.title) : "Untitled";
    var channel = v && v.channel ? String(v.channel) : "YouTube";
    var published = v && v.published_at ? v.published_at : "";
    var url = v && v.url ? String(v.url) : "";

    var thumb = (v && v.thumbnail ? String(v.thumbnail) : "");
    if (!thumb) thumb = window.location.origin + "/assets/og-default.png";

    var ai = v && v.ai ? v.ai : {};
    var summary = ai && ai.summary ? String(ai.summary) : "";
    var bullets = ai && Array.isArray(ai.bullets) ? ai.bullets : [];
    var takeaways = ai && Array.isArray(ai.takeaways) ? ai.takeaways : [];
    var tags = ai && Array.isArray(ai.tags) ? ai.tags : [];

    var meta = ["VIDEO", channel, published ? fmtUtc(published) : ""].filter(Boolean).join(" • ");
    var ptdUrl = mediaArticleUrl(id);

    return ''
      + '<article class="card">'
      +   '<div class="meta">' + escapeHtml(meta) + '</div>'
      +   '<div class="row">'
      +     '<a class="thumb" href="' + escapeHtml(url) + '" target="_blank" rel="noopener" aria-label="Open on YouTube">'
      +       '<img loading="lazy" src="' + escapeHtml(thumb) + '" alt="">'
      +       '<span class="play">▶ YouTube</span>'
      +     '</a>'
      +     '<div>'
      +       '<h2>' + escapeHtml(title) + '</h2>'
      +       (summary ? '<p class="summary">' + escapeHtml(summary) + '</p>' : '')
      +       (bullets.length ? (
                '<div class="subhead">Key points</div>'
              + '<ul>' + bullets.slice(0,5).map(function(b){ return '<li>' + escapeHtml(b) + '</li>'; }).join("") + '</ul>'
            ) : '')
      +       (takeaways.length ? (
                '<div class="subhead">So what</div>'
              + '<ul>' + takeaways.slice(0,4).map(function(t){ return '<li>' + escapeHtml(t) + '</li>'; }).join("") + '</ul>'
            ) : '')
      +       (tags.length ? (
                '<div class="chips">'
              + tags.slice(0,10).map(function(t){ return '<span class="chip">' + escapeHtml(t) + '</span>'; }).join("")
              + '</div>'
            ) : '')
      +       '<div class="cta">'
      +         '<a class="btnMini primary" href="' + escapeHtml(ptdUrl) + '" target="_blank" rel="noopener">Open PTD Summary</a>'
      +         '<a class="btnMini" href="' + escapeHtml(url) + '" target="_blank" rel="noopener">Watch</a>'
      +       '</div>'
      +     '</div>'
      +   '</div>'
      + '</article>';
  }

  function render(payload, query) {
    query = query || "";

    var updatedAt = payload && payload.updated_at ? payload.updated_at : "";
    if ($("updatedLine")) $("updatedLine").textContent = updatedAt ? ("Updated — " + fmtUtc(updatedAt)) : "Updated —";

    var disclaimer = (payload && payload.disclaimer) ? payload.disclaimer :
      "Informational only — AI-generated summaries; may contain errors. Verify with the original video.";
    if ($("disclaimerLine")) $("disclaimerLine").textContent = disclaimer;

    var utcToday = new Date().toISOString().slice(0,10) + " (UTC)";
    if ($("datePill")) $("datePill").textContent = "UTC Today: " + utcToday;

    var all = (payload && Array.isArray(payload.items)) ? payload.items : [];
    var items = applySearch(all, query);

    if ($("countPill")) $("countPill").textContent = "Items: " + items.length;

    if ($("grid")) {
      $("grid").innerHTML = items.length
        ? items.map(cardHtml).join("")
        : '<div class="errorBox"><strong>No videos for today (UTC) from your selected channels.</strong></div>';
    }
  }

  function showError(msg) {
    if ($("updatedLine")) $("updatedLine").textContent = "Could not load Media.";
    if ($("grid")) {
      $("grid").innerHTML =
        '<div class="errorBox">'
      +   '<strong>Media not available yet.</strong><br/>'
      +   'Expected file: <code>' + escapeHtml(DATA_URL) + '</code><br/>'
      +   '<div style="margin-top:10px;color:#6b665c;">' + escapeHtml(msg) + '</div>'
      + '</div>';
    }
  }

  // Watchdog: if nothing happens in 6 seconds, show a real error.
  var watchdog = setTimeout(function () {
    showError("Timeout loading " + DATA_URL + ". (JS ran, but fetch did not finish.)");
  }, 6000);

  function load() {
    try {
      if ($("year")) $("year").textContent = String(new Date().getFullYear());

      fetch(DATA_URL, { cache: "no-store" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load " + DATA_URL + " (" + res.status + ")");
          return res.json();
        })
        .then(function (payload) {
          clearTimeout(watchdog);
          render(payload, $("q") ? $("q").value : "");
          if ($("q")) {
            $("q").addEventListener("input", function () {
              render(payload, $("q").value);
            });
          }
        })
        .catch(function (err) {
          clearTimeout(watchdog);
          showError(err && err.message ? err.message : String(err));
        });
    } catch (e) {
      clearTimeout(watchdog);
      showError(e && e.message ? e.message : String(e));
    }
  }

  // Ensure DOM is ready (iOS Safari sometimes needs this)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", load);
  } else {
    load();
  }

  if ($("btnRefresh")) $("btnRefresh").addEventListener("click", function () { location.reload(); });
})();
</script>